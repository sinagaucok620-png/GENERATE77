<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Scheduler v16.5 - Clean Layout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00f2ff;
            --glass-bg: rgba(15, 20, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --win-green: #00ff88;
            --warn-yellow: #ffd700;
            --danger-red: #ff3e3e;
            --wa-green: #25D366;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; padding: 40px 20px;
            color: #fff; -webkit-font-smoothing: antialiased;
            min-height: 100vh; background-color: #000;
            overflow-x: hidden; cursor: crosshair;
            transition: background 0.3s ease;
        }

        #nebula-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        #cursor-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; }

        .container { 
            max-width: 1300px; margin: auto; 
            background: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 40px; border-radius: 20px; 
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            position: relative; z-index: 1;
            transition: all 0.3s ease;
        }

        /* HEADER & DATE LAYOUT */
        .header-area { 
            text-align: center; margin-bottom: 30px; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 20px;
        }
        .header-area h2 { 
            color: var(--primary); margin: 0 0 20px 0; font-size: 48px; font-weight: 800; 
            letter-spacing: 5px; text-transform: uppercase;
            text-shadow: 0 0 20px var(--primary);
        }
        
        /* DATE WRAPPER DI HEADER */
        .date-range-wrapper {
            display: inline-flex; align-items: flex-end; gap: 15px;
            background: rgba(0,0,0,0.3); padding: 15px 25px; border-radius: 12px;
            border: 1px solid var(--glass-border); margin-bottom: 10px;
        }
        .date-input-group { display: flex; flex-direction: column; gap: 5px; text-align: left; }
        .date-input-group label { font-size: 11px; color: var(--primary); font-weight: bold; letter-spacing: 1px; }
        .arrow-separator { font-size: 24px; color: #fff; padding-bottom: 8px; opacity: 0.5; }

        #displayDate { 
            color: #aaa; font-size: 12px; margin-top: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;
        }

        /* CONTROLS (TOMBOL AKSI) */
        .controls { 
            display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; 
            background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; margin-bottom: 20px;
            border: 1px solid var(--glass-border);
        }

        .time-settings {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px;
            margin-bottom: 30px; border: 1px dashed rgba(255,255,255,0.2);
            width: 100%; max-width: 1220px; margin: 0 auto 30px;
        }
        .time-settings summary { cursor: pointer; color: var(--warn-yellow); font-weight: bold; margin-bottom: 10px; outline: none; }
        .time-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .time-group label { display: block; font-size: 10px; color: #aaa; margin-bottom: 3px; }
        .time-group input { width: 90%; font-size: 12px; padding: 8px; }

        input, select { 
            background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); 
            padding: 12px 20px; border-radius: 8px; font-size: 14px; outline: none; 
            font-family: 'Rajdhani', sans-serif; font-weight: 700; cursor: pointer;
        }
        input:focus, select:focus { border-color: var(--primary); background: #000; }
        input[type="date"] { text-transform: uppercase; color-scheme: dark; }
        input[readonly] { background: rgba(0,0,0,0.3); color: #aaa; border-color: transparent; cursor: default; }

        #historySelect, #musicSelect {
            max-width: 150px;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.5);
            color: #aaa;
        }
        #musicSelect { color: var(--win-green); border-color: var(--win-green); }

        button { 
            background: var(--primary); color: #000; border: none; 
            padding: 12px 25px; cursor: pointer; border-radius: 8px; font-weight: 800; 
            text-transform: uppercase; font-size: 14px; transition: 0.3s;
            position: relative; overflow: hidden; display: flex; align-items: center; gap: 8px;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 20px var(--primary); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        
        #musicBtn { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        #musicBtn.playing { background: var(--win-green); color: #000; border-color: transparent; box-shadow: 0 0 20px var(--win-green); }

        #lockBtn { padding: 12px 15px; width: 50px; display: flex; justify-content: center; background: rgba(255,255,255,0.1); color: #fff; }
        #lockBtn.locked { background: var(--danger-red); }

        #shareBtn { background: #6c5ce7; color: #fff; }
        #shareBtn:hover { box-shadow: 0 0 15px #6c5ce7; }
        
        #waBtn { background: var(--wa-green); color: #fff; }
        #waBtn:hover { box-shadow: 0 0 15px var(--wa-green); }

        #designerBtn { background: #fff; color: #000; border: 1px solid #999; }
        #designerBtn:hover { box-shadow: 0 0 15px #fff; }

        .btn-copy { background: #222 !important; color: #fff !important; border: 1px solid #444 !important; }
        .btn-save { background: #10b981 !important; color: #fff !important; }

        .day-row { margin-bottom: 50px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .day-label { 
            font-size: 28px; color: #fff; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;
            border-left: 5px solid var(--primary); padding-left: 15px; 
            text-shadow: 0 0 10px rgba(255,255,255,0.2);
        }
        .date-badge { font-size: 16px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 6px; color: var(--primary); letter-spacing: 1px; font-family: monospace; }
        
        .session-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        
        .session-box { 
            background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.05); height: 100%; 
            transition: 0.3s; position: relative;
        }
        .session-box:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .smart-copy-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.5); color: var(--primary);
            border: 1px solid var(--primary);
            width: 30px; height: 30px; padding: 0;
            border-radius: 6px; display: flex; justify-content: center; align-items: center;
            opacity: 0.6; cursor: pointer; transition: 0.2s; z-index: 10;
        }
        .smart-copy-btn:hover { opacity: 1; background: var(--primary); color: #000; }

        .session-title { color: var(--primary); font-weight: 800; font-size: 16px; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .session-time { font-size: 11px; color: #aaa; display: block; margin-bottom: 10px; font-family: monospace; }
        .provider-label { font-size: 10px; color: #888; font-weight: 700; margin: 15px 0 5px; text-transform: uppercase; letter-spacing: 1px; }

        .game-card { 
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent;
            transition: 0.2s; cursor: pointer; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .game-card:hover { border-color: var(--primary); background: var(--primary); box-shadow: 0 0 15px var(--primary); }
        .game-card:hover .game-name { color: #000; text-shadow: none; }
        .game-name { font-size: 12px; font-weight: 700; color: #ddd; }
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #000; border: 1px solid #333; }

        .depo-container { margin-top: 15px; background: rgba(0,0,0,0.2); border: 1px dashed rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; }
        .depo-header { font-size: 11px; color: var(--primary); font-weight: 800; text-align: center; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .depo-item { margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .depo-item:last-child { border: none; margin: 0; }
        .depo-info { font-size: 11px; color: #fff; display: block; margin-bottom: 3px; }
        .depo-meta { font-size: 10px; display: flex; justify-content: space-between; }
        .tag-bonus { color: #ff9f43; font-weight: 800; } .tag-rate { color: var(--win-green); font-weight: 800; }

        .guide-container { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 8px; }
        .step-row { font-size: 10px; color: #888; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; display: flex; justify-content: space-between; }

        .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10000; pointer-events: none; }
        .toast { background: rgba(10, 10, 10, 0.95); border: 2px solid var(--primary); color: var(--primary); padding: 15px 40px; border-radius: 50px; font-weight: 800; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; box-shadow: 0 0 50px var(--primary); opacity: 0; transform: translateY(20px); transition: all 0.4s; display: flex; align-items: center; gap: 12px; }
        .toast.show { opacity: 1; transform: translateY(0); }

        #hover-tooltip {
            position: fixed; display: none; z-index: 10000;
            background: #000; border: 2px solid var(--primary);
            border-radius: 10px; padding: 5px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            pointer-events: none; 
            max-width: 200px;
        }
        #hover-tooltip img { width: 100%; border-radius: 5px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #111; padding: 20px; border: 1px solid var(--primary); border-radius: 15px; max-width: 400px; text-align: center; box-shadow: 0 0 30px var(--primary); }
        .modal-content img { width: 100%; border-radius: 10px; margin-bottom: 10px; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: #fff; background: none; border: none; font-size: 24px; cursor: pointer; }

        @media (max-width: 1100px) { .session-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 700px) { .container{padding:20px;} .session-grid { grid-template-columns: 1fr; } .time-inputs{ grid-template-columns: 1fr; } .date-range-wrapper{flex-wrap: wrap; justify-content: center;} }

        body.clean-mode { background: #f4f6f8 !important; color: #222 !important; cursor: default; }
        body.clean-mode #nebula-canvas, body.clean-mode #cursor-canvas, body.clean-mode #particle-canvas { display: none !important; }
        body.clean-mode .container { background: #ffffff; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #d1d5db; border-top: 5px solid #333; }
        body.clean-mode .header-area h2 { color: #111 !important; text-shadow: none !important; font-weight: 900; }
        body.clean-mode #displayDate { color: #555; font-weight: 600; }
        body.clean-mode .controls, body.clean-mode .time-settings { background: #f3f4f6; border: 1px solid #e5e7eb; box-shadow: none; color: #000; }
        body.clean-mode .time-settings summary { color: #333; }
        body.clean-mode .time-group label { color: #555; }
        body.clean-mode .time-group input { background: #fff; color: #000; border: 1px solid #ccc; }
        body.clean-mode #musicBtn, body.clean-mode #musicSelect, body.clean-mode #lockBtn, body.clean-mode #startDateInput, body.clean-mode #genBtn, body.clean-mode #historySelect, body.clean-mode #waBtn { opacity: 0.3; pointer-events: none; filter: grayscale(100%); }
        body.clean-mode .day-label { color: #000; border-left-color: #000; text-shadow: none; }
        body.clean-mode .date-badge { background: #e0e0e0; color: #333; font-weight: bold; border: 1px solid #ccc; }
        body.clean-mode .session-box { background: #fff; border: 2px solid #e5e7eb; box-shadow: none; }
        body.clean-mode .session-title { color: #000; border-bottom: 2px solid #000; }
        body.clean-mode .session-time { color: #666; font-weight: bold; }
        body.clean-mode .smart-copy-btn { background: #000; color: #fff; border: none; opacity: 1; }
        body.clean-mode .provider-label { color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        body.clean-mode .game-card { background: #f9fafb; border: 1px solid #d1d5db; color: #111; }
        body.clean-mode .game-card .game-name { color: #000; font-size: 13px; }
        body.clean-mode .game-card:hover { background: #fff; border-color: #000; box-shadow: none; }
        body.clean-mode .depo-container { background: #fffbe6; border: 1px solid #ffe58f; color: #000; }
        body.clean-mode .depo-header { color: #d46b08; border-bottom: 1px solid #ffe58f; }
        body.clean-mode .depo-info { color: #222; font-family: monospace; font-size: 12px; font-weight: bold; }
        body.clean-mode .badge { background: #eee !important; color: #000 !important; border: 1px solid #ccc; }
        body.clean-mode #designerBtn { background: #000; color: #fff; border-color: #000; }
    </style>
</head>
<body>

<canvas id="nebula-canvas"></canvas>
<canvas id="cursor-canvas"></canvas>
<canvas id="particle-canvas"></canvas>

<div class="toast-container"><div id="customToast" class="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">ACTION SUCCESSFUL</span></div></div>
<div id="hover-tooltip"><img id="tooltip-img" src="" alt=""></div>

<div id="youtube-player" style="display: none;"></div>

<div id="gameModal" class="modal" onclick="document.getElementById('gameModal').style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="document.getElementById('gameModal').style.display='none'">X</button>
        <img id="modalImg" src="" alt="">
        <h3 id="modalName" style="color:var(--primary); margin:0;"></h3>
    </div>
</div>

<div class="container">
    <div class="header-area">
        <h2>PLATFORM SCHEDULER V16.5</h2>
        
        <div class="date-range-wrapper">
            <div class="date-input-group">
                <label>DARI TANGGAL</label>
                <input type="date" id="startDateInput" onchange="updateEndDate(); liveUpdateView()">
            </div>
            <div class="arrow-separator">‚û°</div>
            <div class="date-input-group">
                <label>SAMPAI TANGGAL</label>
                <input type="text" id="endDateDisplay" readonly placeholder="Otomatis...">
            </div>
        </div>

        <div id="displayDate">READY TO SYNC</div>
    </div>
    
    <details class="time-settings" id="timeSettings">
        <summary><i class="fas fa-clock"></i> PENGATURAN JAM (EDITABLE)</summary>
        <div class="time-inputs">
            <div class="time-group"><label>MIDNIGHT</label><input type="text" id="timeMidnight" value="00:00 - 06:00 WIB" onchange="saveTimeSettings()"></div>
            <div class="time-group"><label>SIANG</label><input type="text" id="timeSiang" value="06:00 - 15:00 WIB" onchange="saveTimeSettings()"></div>
            <div class="time-group"><label>SORE</label><input type="text" id="timeSore" value="15:00 - 19:00 WIB" onchange="saveTimeSettings()"></div>
            <div class="time-group"><label>MALAM</label><input type="text" id="timeMalam" value="19:00 - 00:00 WIB" onchange="saveTimeSettings()"></div>
        </div>
    </details>

    <div class="controls">
        <select id="profileSelect" onchange="changeProfileHandler()">
            <option value="CAPTAIN77">CAPTAIN77</option>
            <option value="PLAY77">PLAY77</option>
            <option value="JAGUAR77">JAGUAR77</option>
            <option value="FUN77">FUN77</option>
            <option value="INDOPEDIA77">INDOPEDIA77</option>
            <option value="INDOFUN17">INDOFUN17</option>
            <option value="HOLYPLAY17">HOLYPLAY17</option>
            <option value="MUSTANG77">MUSTANG77</option>
        </select>
        
        <button id="lockBtn" onclick="toggleLock()" title="Kunci Tombol Sync"><i class="fas fa-unlock"></i></button>
        <button id="genBtn" onclick="initiateSync()">SYNC DATA</button>
        
        <select id="historySelect" onchange="loadFromHistory()">
            <option value="">‚è≥ RIWAYAT</option>
        </select>
        
        <button id="musicBtn" onclick="toggleMusic()"><i class="fas fa-music"></i> MUSIC OFF</button>
        <select id="musicSelect" onchange="changeMusic()">
            <option value="gCWaRhNUvfc">GAMING (NCS)</option>
            <option value="jfKfPfyJRdk">LOFI CHILL</option>
            <option value="3l0k6wQ6e6k">PHONK</option>
            <option value="S-M1Q8Zc">EDM MIX</option>
        </select>

        <button id="waBtn" onclick="sendToWhatsApp()" title="Kirim ke Designer (+628988385486)">
            <i class="fab fa-whatsapp"></i> KIRIM
        </button>
        <button id="shareBtn" onclick="copyShareLink()" title="Copy Link Manual"><i class="fas fa-link"></i> LINK</button>
        
        <button id="designerBtn" onclick="toggleDesignerMode()" title="Mode Baca Mudah untuk Designer">
            <i class="fas fa-eye"></i> MODE DESIGNER
        </button>

        <button id="copyBtn" class="btn-copy" style="display:none" onclick="copyText()">COPY ALL</button>
        <button id="saveBtn" class="btn-save" style="display:none" onclick="downloadPNG()">EXPORT PNG</button>
    </div>

    <div id="capture-area"><div id="hasil"></div></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
// --- ALGORITMA RNG MULBERRY32 (ANTI-ERROR BEDA PERANGKAT) ---
let currentSeed = Date.now(); 

function mulberry32(a) {
    return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
}

// Wrapper untuk kompabilitas
function seedRandom(seed) {
    return mulberry32(seed);
}

let myRandom = Math.random; 

function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex != 0) {
        randomIndex = Math.floor(myRandom() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// --- LOGIKA TANGGAL RANGE BARU ---
function updateEndDate() {
    const startVal = document.getElementById("startDateInput").value;
    if (!startVal) return;
    
    const startDate = new Date(startVal);
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    
    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    document.getElementById("endDateDisplay").value = endDate.toLocaleDateString('id-ID', options).toUpperCase();
}

// --- HISTORY SYSTEM ---
let seedHistory = []; 
function addToHistory(oldSeed) {
    if (!oldSeed) return;
    const currentProfile = document.getElementById("profileSelect").value;
    const time = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    seedHistory.unshift({ seed: oldSeed, time: time, profile: currentProfile });
    if (seedHistory.length > 50) seedHistory.pop();
    updateHistoryUI();
}
function updateHistoryUI() {
    const sel = document.getElementById("historySelect");
    const currentProfile = document.getElementById("profileSelect").value;
    sel.innerHTML = '<option value="">‚è≥ RIWAYAT</option>';
    const filteredHistory = seedHistory.filter(item => item.profile === currentProfile);
    filteredHistory.slice(0, 5).forEach((item) => {
        const originalIndex = seedHistory.indexOf(item);
        sel.innerHTML += `<option value="${originalIndex}">${item.time} (Seed: ${item.seed.toString().slice(-4)})</option>`;
    });
}
function loadFromHistory() {
    const sel = document.getElementById("historySelect");
    if (sel.value === "") return;
    const index = parseInt(sel.value);
    const item = seedHistory[index];
    if (item) {
        currentSeed = item.seed;
        myRandom = seedRandom(currentSeed);
        updateUrlState(); 
        fetchDatabase();
        showToast(`RESTORED: ${item.time}`);
    }
    sel.value = ""; 
}

// --- LIVE SYNC LOGIC ---
function liveUpdateView() {
    myRandom = seedRandom(currentSeed); 
    updateUrlState();
    generateJadwal(); 
    showToast("TANGGAL DIPERBARUI");
}

function updateUrlState() {
    const profile = document.getElementById("profileSelect").value;
    const inputDate = document.getElementById("startDateInput").value;
    let newUrl = `${window.location.pathname}?profile=${profile}&seed=${currentSeed}`;
    if(inputDate) newUrl += `&date=${inputDate}`;
    window.history.pushState({path: newUrl}, '', newUrl);
}

function changeProfileHandler() { 
    changeTheme(); 
    updateHistoryUI(); 
    liveUpdateView(); 
}

// --- TIME SETTINGS STORAGE ---
function saveTimeSettings() {
    const settings = {
        midnight: document.getElementById('timeMidnight').value,
        siang: document.getElementById('timeSiang').value,
        sore: document.getElementById('timeSore').value,
        malam: document.getElementById('timeMalam').value
    };
    localStorage.setItem('schedulerTimeSettings', JSON.stringify(settings));
    liveUpdateView(); 
}
function loadTimeSettings() {
    const saved = localStorage.getItem('schedulerTimeSettings');
    if (saved) {
        const s = JSON.parse(saved);
        if(s.midnight) document.getElementById('timeMidnight').value = s.midnight;
        if(s.siang) document.getElementById('timeSiang').value = s.siang;
        if(s.sore) document.getElementById('timeSore').value = s.sore;
        if(s.malam) document.getElementById('timeMalam').value = s.malam;
    }
}

// --- WHATSAPP FEATURE ---
function sendToWhatsApp() {
    if (!window.location.href.includes("seed=")) {
        showToast("KLIK 'SYNC DATA' DULU!");
        return;
    }
    const prof = document.getElementById("profileSelect").value;
    const dateRange = document.getElementById("displayDate").innerText.replace("PERIODE: ", "");
    const url = encodeURIComponent(window.location.href);
    
    let msg = `Halo Designer, ini jadwal *${prof}* untuk periode *${dateRange}*.\n\nSilakan diproses:\n${url}`;
    
    window.open(`https://wa.me/628988385486?text=${encodeURIComponent(msg)}`, '_blank');
}

// --- LOGIKA UTAMA ---
let isLocked = false;
function toggleLock() {
    isLocked = !isLocked;
    const lockBtn = document.getElementById("lockBtn");
    const genBtn = document.getElementById("genBtn");
    const dateInput = document.getElementById("startDateInput");
    
    if (isLocked) {
        lockBtn.innerHTML = '<i class="fas fa-lock"></i>';
        lockBtn.classList.add("locked");
        genBtn.disabled = true; genBtn.style.opacity = "0.5"; genBtn.style.cursor = "not-allowed";
        dateInput.disabled = true;
    } else {
        lockBtn.innerHTML = '<i class="fas fa-unlock"></i>';
        lockBtn.classList.remove("locked");
        genBtn.disabled = false; genBtn.style.opacity = "1"; genBtn.style.cursor = "pointer";
        dateInput.disabled = false;
    }
}

function toggleDesignerMode() {
    const body = document.body;
    const btn = document.getElementById("designerBtn");
    body.classList.toggle("clean-mode");
    if (body.classList.contains("clean-mode")) {
        btn.innerHTML = '<i class="fas fa-paint-brush"></i> KEMBALI KE NEON';
        showToast("MODE DESIGNER: AKTIF");
        document.addEventListener('mousemove', handleTooltip);
    } else {
        btn.innerHTML = '<i class="fas fa-eye"></i> MODE DESIGNER';
        showToast("MODE NEON: KEMBALI");
        document.removeEventListener('mousemove', handleTooltip);
        document.getElementById('hover-tooltip').style.display = 'none';
    }
}

function handleTooltip(e) {
    if (!document.body.classList.contains('clean-mode')) return;
    const target = e.target.closest('.game-card');
    const tooltip = document.getElementById('hover-tooltip');
    const tooltipImg = document.getElementById('tooltip-img');
    
    if (target) {
        const name = target.querySelector('.game-name').innerText;
        if (gameImageMap[name]) {
            tooltipImg.src = gameImageMap[name];
            tooltip.style.display = 'block';
            tooltip.style.top = (e.clientY + 15) + 'px';
            tooltip.style.left = (e.clientX + 15) + 'px';
        }
    } else {
        tooltip.style.display = 'none';
    }
}

var player; var isPlaying = false;
function onYouTubeIframeAPIReady() {
    const defaultVid = document.getElementById("musicSelect").value;
    player = new YT.Player('youtube-player', {
        height: '0', width: '0', videoId: defaultVid,
        playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': defaultVid }
    });
}
function changeMusic() {
    const vid = document.getElementById("musicSelect").value;
    if (player) { player.loadVideoById(vid); if (isPlaying) player.playVideo(); else player.pauseVideo(); }
}
function toggleMusic() {
    const btn = document.getElementById('musicBtn');
    if (!player) return;
    if (isPlaying) { player.pauseVideo(); btn.innerHTML = '<i class="fas fa-music"></i> MUSIC OFF'; btn.classList.remove('playing'); isPlaying = false; } 
    else { player.playVideo(); btn.innerHTML = '<i class="fas fa-volume-up"></i> MUSIC ON'; btn.classList.add('playing'); isPlaying = true; }
}
function showToast(msg) {
    const toast = document.getElementById("customToast");
    document.getElementById("toastMsg").innerText = msg;
    toast.classList.add("show");
    setTimeout(() => { toast.classList.remove("show"); }, 3000);
}

const PROFILE_CONFIG = {
    "CAPTAIN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=0&single=true&output=csv",
    "JAGUAR77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1165225864&single=true&output=csv",
    "INDOPEDIA77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=288756155&single=true&output=csv",
    "FUN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=288756155&single=true&output=csv",
    "PLAY77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=410917478&single=true&output=csv",
    "MUSTANG77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1769820056&single=true&output=csv",
    "HOLYPLAY17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=265631998&single=true&output=csv",
    "INDOFUN17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=2086618792&single=true&output=csv"
};

const THEMES = {
    "CAPTAIN77": { primary: "#00f2ff", nebula: ["#000000", "#000428", "#004e92", "#00f2ff"] },
    "PLAY77": { primary: "#3b82f6", nebula: ["#000000", "#020024", "#090979", "#3b82f6"] },
    "JAGUAR77": { primary: "#FFD700", nebula: ["#000000", "#1c1003", "#4a3b00", "#FFD700"] },
    "FUN77": { primary: "#ff3e3e", nebula: ["#000000", "#220000", "#430000", "#ff3e3e"] },
    "INDOPEDIA77": { primary: "#4ade80", nebula: ["#000000", "#022c22", "#064e3b", "#4ade80"] },
    "INDOFUN17": { primary: "#ff0055", nebula: ["#000000", "#330011", "#80002a", "#ff0055"] },
    "HOLYPLAY17": { primary: "#d8b4fe", nebula: ["#000000", "#1e0033", "#581c87", "#d8b4fe"] },
    "MUSTANG77": { primary: "#00ff88", nebula: ["#000000", "#001a00", "#003300", "#004d00"] }
};

let currentNebulaColors = THEMES["CAPTAIN77"].nebula;
let poolPragmatic = { gold:[], silver:[], bronze:[], guide:[] };
let poolPGSoft = { gold:[], silver:[], bronze:[], guide:[] };
let gameImageMap = {};
let depositSettings = { "MIDNIGHT":[], "SIANG":[], "SORE":[], "MALAM":[] };
let globalMemory = [];
let uniqueCodePool = [];

function changeTheme() {
    const selected = document.getElementById("profileSelect").value;
    const theme = THEMES[selected] || THEMES["CAPTAIN77"];
    document.documentElement.style.setProperty('--primary', theme.primary);
    currentNebulaColors = theme.nebula;
}

function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const seed = urlParams.get('seed');
    const profile = urlParams.get('profile');
    const dateParam = urlParams.get('date');
    
    if (seed && profile) {
        currentSeed = parseInt(seed); 
        myRandom = seedRandom(currentSeed); 
        document.getElementById("profileSelect").value = profile;
        if(dateParam) {
            document.getElementById("startDateInput").value = dateParam;
            updateEndDate(); 
        }
        changeProfileHandler(); 
        fetchDatabase();
    } else {
        currentSeed = Date.now();
        myRandom = Math.random;
        document.getElementById("startDateInput").valueAsDate = new Date();
        updateEndDate(); 
        loadTimeSettings(); 
        updateHistoryUI();
        updateUrlState(); 
    }
}

function initiateSync() {
    addToHistory(currentSeed);
    currentSeed = Date.now();
    myRandom = seedRandom(currentSeed); 
    updateUrlState();
    fetchDatabase();
}

function copyShareLink() {
    const url = window.location.href;
    if (!url.includes("seed=")) { showToast("KLIK 'SYNC DATA' DULU!"); return; }
    navigator.clipboard.writeText(url).then(() => { showToast("LINK TERSALIN! KIRIM KE DESIGNER"); });
}

async function fetchDatabase() {
    const selected = document.getElementById("profileSelect").value;
    const btn = document.getElementById("genBtn");
    btn.disabled = true; btn.innerText = "LOADING...";
    
    try {
        const response = await fetch(PROFILE_CONFIG[selected]);
        const data = await response.text();
        const lines = data.split(/\r?\n/).filter(l => l.trim() !== "");

        poolPragmatic = { gold:[], silver:[], bronze:[], guide:[] };
        poolPGSoft = { gold:[], silver:[], bronze:[], guide:[] };
        gameImageMap = {};
        depositSettings = { "MIDNIGHT":[], "SIANG":[], "SORE":[], "MALAM":[] };

        lines.slice(1).forEach(line => {
            let cleanLine = line.replace(/"/g, ''); 
            let cols = cleanLine.split(',').map(c => c.trim());
            if (cols.length >= 3) {
                const prov = cols[0]; const tier = cols[1].toUpperCase(); const name = cols[2]; 
                let meta = cols[3] || ""; let extra = cols[4] || ""; 
                if (!meta.includes('|') && extra !== "") { meta = meta + "|" + extra; }
                meta = meta.replace(/\*\*/g, '');

                if (prov === "SETTING" && tier.startsWith("DEPO_")) {
                    const sess = tier.replace("DEPO_", "");
                    if (depositSettings[sess]) depositSettings[sess].push({ range: name, info: meta });
                } else if (name && name !== "") {
                    if (meta && !meta.includes('|')) gameImageMap[name] = meta; 
                    const t = cols[1].toLowerCase();
                    if (prov === "Pragmatic") { if(t==='guide') poolPragmatic.guide.push(name); else if(poolPragmatic[t]) poolPragmatic[t].push(name); }
                    else if (prov === "PGSoft") { if(t==='guide') poolPGSoft.guide.push(name); else if(poolPGSoft[t]) poolPGSoft[t].push(name); }
                }
            }
        });
        
        myRandom = seedRandom(currentSeed); 
        generateJadwal();
        btn.disabled = false; btn.innerText = "SYNC DATA";
        if(isLocked) btn.disabled = true;

    } catch (e) {
        alert("Gagal mengambil data! Cek koneksi.");
        btn.disabled = false; btn.innerText = "RETRY";
    }
}

function getUniqueCode() {
    if (uniqueCodePool.length === 0) {
        uniqueCodePool = [500,1000,1500,2000,2500,3000,3500,4000,4500,5000,111,222,333,555,777,888,999,123,234,345,600,700,800,900];
        shuffleArray(uniqueCodePool);
    }
    return uniqueCodePool.pop();
}

function getStrategy(prov) {
    let list = (prov === 'Pragmatic') ? poolPragmatic.guide : poolPGSoft.guide;
    if (!list || list.length < 3) return { html: "<div>Pola Kurang</div>", text: "" };
    
    let dcText = "";
    let badgeHtml = "";
    if (prov === 'Pragmatic') {
        const state = myRandom() > 0.5 ? "ON" : "OFF";
        dcText = `FITUR GANDA ${state}`;
        badgeHtml = `<span class="badge" style="background:var(--primary); color:#000; margin-bottom:5px; display:inline-block;">${dcText}</span>`;
    }

    let shuffledList = [...list]; shuffleArray(shuffledList);
    let selected = shuffledList.slice(0, 5);
    let stepsHtml = selected.map(s => `<div class="step-row"><span>${s}</span></div>`).join('');
    let stepsText = selected.map(s => `> ${s}`).join('\n');
    let fullText = `${dcText ? dcText + '\n' : ''}${stepsText}`;

    return { html: `<div class="guide-container">${badgeHtml}${stepsHtml}</div>`, text: fullText };
}

function getDeposit(sess) {
    let tail = getUniqueCode();
    let data = depositSettings[sess];
    if (!data || data.length === 0) return { html: "", text: "", code: tail };

    let html = `<div class="depo-container"><div class="depo-header">KODE JITU EKOR: ${tail}</div>`;
    let text = "";

    data.forEach((item, i) => {
        let parts = item.range.split('-');
        let meta = item.info.split('|');
        let bonus = meta[0] || "UNK";
        let rate = meta[1] || "90%";
        let nominal = parts.length === 2 ? `DEPO Rp ${(parseInt(parts[0])+tail).toLocaleString()} - Rp ${(parseInt(parts[1])+tail).toLocaleString()}` : `SPECIAL DEPO Rp ${(parseInt(parts[0])+tail).toLocaleString()}`;
        html += `<div class="depo-item"><span class="depo-info">${i+1}. ${nominal}</span><div class="depo-meta"><span class="tag-bonus">BONUS ${bonus}</span><span class="tag-rate">RATE ${rate}</span></div></div>`;
        text += `${i+1}. ${nominal} (Bonus ${bonus} | Rate ${rate})\n`;
    });
    html += `</div>`;
    return { html, text, code: tail };
}

function pickGame(prov, tier, blacklist, daily) {
    let list = (prov === 'Pragmatic') ? poolPragmatic[tier] : poolPGSoft[tier];
    if (!list || list.length === 0) return { name: "DATA KOSONG", html: "" };
    let available = list.filter(g => !blacklist.includes(g) && !daily.includes(g));
    if (available.length === 0) available = list;
    const chosen = available[Math.floor(myRandom() * available.length)];
    return { 
        name: chosen, 
        html: `<div class="game-card" onclick="showImg('${chosen}')"><span class="game-name">${chosen}</span><span class="badge" style="background:${tier==='gold'?'#ffd700':tier==='silver'?'#c0c0c0':'#cd7f32'};color:#000">${tier}</span></div>`
    };
}

function showImg(name) {
    document.getElementById('modalName').innerText = name;
    document.getElementById('modalImg').src = gameImageMap[name] || 'https://via.placeholder.com/400x250?text=NO+IMAGE';
    document.getElementById('gameModal').style.display = 'flex';
}

function generateJadwal() {
    const dateInputStr = document.getElementById('startDateInput').value;
    let startDate = dateInputStr ? new Date(dateInputStr) : new Date();
    
    let endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6);
    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    const dateRangeStr = `${startDate.toLocaleDateString('id-ID', options)} - ${endDate.toLocaleDateString('id-ID', options)}`;
    document.getElementById('displayDate').innerText = `PERIODE: ${dateRangeStr.toUpperCase()}`;

    const tMid = document.getElementById('timeMidnight').value;
    const tSiang = document.getElementById('timeSiang').value;
    const tSore = document.getElementById('timeSore').value;
    const tMalam = document.getElementById('timeMalam').value;

    const days = ["SENIN","SELASA","RABU","KAMIS","JUMAT","SABTU","MINGGU"];
    uniqueCodePool = []; 
    
    let html = "";
    globalMemory = [];
    let yesterday = [];

    days.forEach((day, dayIndex) => {
        let currentDate = new Date(startDate); currentDate.setDate(startDate.getDate() + dayIndex);
        let dateBadge = currentDate.toLocaleDateString('id-ID', {day: '2-digit', month: '2-digit', year: '2-digit'});

        let todayGames = [];
        let dayData = { day: day, date: dateBadge, sessions: [] };
        
        const draw = (p, t) => { let res = pickGame(p, t, yesterday, todayGames); if (res.name !== "DATA KOSONG") todayGames.push(res.name); return res; }
        const buildSession = (label, timeStr, key, func, sessIndex) => {
            let games = func();
            let depo = getDeposit(key);
            dayData.sessions.push({ title: label, time: timeStr, games: games.rawText, depo: depo });
            
            return `
            <div class="session-box">
                <button class="smart-copy-btn" onclick="copySession(${dayIndex}, ${sessIndex})" title="Copy FULL Data Sesi Ini"><i class="fas fa-copy"></i></button>
                <div class="session-title">${label}</div>
                <span class="session-time">${timeStr}</span>
                ${games.html}${depo.html}
            </div>`;
        };

        html += `<div class="day-row"><span class="day-label">${day} <span class="date-badge">${dateBadge}</span></span><div class="session-grid">`;
        html += buildSession("üåë MIDNIGHT", tMid, "MIDNIGHT", () => {
            let p1=draw('Pragmatic','gold'), p2=draw('Pragmatic','silver'), p3=draw('Pragmatic','bronze');
            let pg1=draw('PGSoft','gold'), pg2=draw('PGSoft','silver'), stP=getStrategy('Pragmatic'), stPg=getStrategy('PGSoft');
            let rawTxt = `--- PRAGMATIC PLAY ---\n${p1.name}\n${p2.name}\n${p3.name}\n\nPOLA PRAGMATIC:\n${stP.text}\n\n--- PG SOFT ---\n${pg1.name}\n${pg2.name}\n\nPOLA PG SOFT:\n${stPg.text}`;
            return { html: `<div class="provider-label">PRAGMATIC</div>${p1.html}${p2.html}${p3.html}${stP.html}<div class="provider-label">PG SOFT</div>${pg1.html}${pg2.html}${stPg.html}`, rawText: rawTxt };
        }, 0);
        html += buildSession("‚òÄÔ∏è SIANG", tSiang, "SIANG", () => {
            let p1=draw('Pragmatic','gold'), p2=draw('Pragmatic','silver'), pg1=draw('PGSoft','gold'), pg2=draw('PGSoft','bronze');
            let stP=getStrategy('Pragmatic'), stPg=getStrategy('PGSoft');
            let rawTxt = `--- PRAGMATIC PLAY ---\n${p1.name}\n${p2.name}\n\nPOLA PRAGMATIC:\n${stP.text}\n\n--- PG SOFT ---\n${pg1.name}\n${pg2.name}\n\nPOLA PG SOFT:\n${stPg.text}`;
            return { html: `<div class="provider-label">PRAGMATIC</div>${p1.html}${p2.html}${stP.html}<div class="provider-label">PG SOFT</div>${pg1.html}${pg2.html}${stPg.html}`, rawText: rawTxt };
        }, 1);
        html += buildSession("üåá SORE", tSore, "SORE", () => {
            let p1=draw('Pragmatic','gold'), pg1=draw('PGSoft','gold'), stP=getStrategy('Pragmatic'), stPg=getStrategy('PGSoft');
            let rawTxt = `--- PRAGMATIC PLAY ---\n${p1.name}\n\nPOLA PRAGMATIC:\n${stP.text}\n\n--- PG SOFT ---\n${pg1.name}\n\nPOLA PG SOFT:\n${stPg.text}`;
            return { html: `<div class="provider-label">PRAGMATIC</div>${p1.html}${stP.html}<div class="provider-label">PG SOFT</div>${pg1.html}${stPg.html}`, rawText: rawTxt };
        }, 2);
        html += buildSession("üåô MALAM", tMalam, "MALAM", () => {
            let p1=draw('Pragmatic','gold'), stP=getStrategy('Pragmatic');
            let rawTxt = `--- PRAGMATIC PLAY ---\n${p1.name}\n\nPOLA PRAGMATIC:\n${stP.text}`;
            return { html: `<div class="provider-label">PRAGMATIC</div>${p1.html}${stP.html}`, rawText: rawTxt };
        }, 3);
        html += `</div></div>`;
        globalMemory.push(dayData);
        yesterday = [...todayGames];
    });

    document.getElementById("hasil").innerHTML = html;
    document.getElementById("copyBtn").style.display = "inline-block";
    document.getElementById("saveBtn").style.display = "inline-block";
}

function copySession(dayIndex, sessIndex) {
    const data = globalMemory[dayIndex].sessions[sessIndex];
    const dayName = globalMemory[dayIndex].day;
    const dateStr = globalMemory[dayIndex].date;
    
    let txt = `=================================\n`;
    txt += `HARI: ${dayName}, ${dateStr}\n`;
    txt += `SESI: ${data.title} (${data.time})\n`;
    txt += `=================================\n\n`;
    txt += `${data.games}\n\n`;
    txt += `---------------------------------\n`;
    txt += `KODE EKOR: ${data.depo.code}\n`;
    txt += `---------------------------------\n`;
    txt += `LIST DEPOSIT:\n${data.depo.text}`;
    
    navigator.clipboard.writeText(txt).then(() => { showToast(`COPIED FULL: ${dayName} ${data.title}`); });
}

function copyText() {
    const prof = document.getElementById("profileSelect").value;
    const dateRange = document.getElementById("displayDate").innerText;
    let txt = `=== JADWAL GACOR ${prof} ===\n${dateRange}\n\n`;
    globalMemory.forEach(d => {
        txt += `\n[ ${d.day}, ${d.date} ]\n`;
        d.sessions.forEach(s => { 
            txt += `\n>>> ${s.title} (${s.time}) <<<\n`;
            txt += `${s.games}\n`;
            txt += `EKOR: ${s.depo.code}\n`;
            txt += `\n${s.depo.text}`;
        });
        txt += `\n------------------------\n`;
    });
    navigator.clipboard.writeText(txt).then(() => showToast("ALL DATA COPIED!"));
}

function downloadPNG() {
    const sel = document.getElementById("profileSelect").value;
    html2canvas(document.getElementById("capture-area"), { scale: 2, backgroundColor: "#000" }).then(canvas => {
        const a = document.createElement("a"); a.href = canvas.toDataURL(); a.download = `Jadwal_${sel}.png`; a.click();
    });
}

const bgCanvas = document.getElementById('nebula-canvas'); const bgCtx = bgCanvas.getContext('2d');
const cursorCanvas = document.getElementById('cursor-canvas'); const cCtx = cursorCanvas.getContext('2d');
const pCanvas = document.getElementById('particle-canvas'); const pCtx = pCanvas.getContext('2d');
let w, h, nebulaLayers = [], stars = [], cursorParticles = [], mouse = { x: 0, y: 0 };

function initVisuals() {
    resize(); window.addEventListener('resize', resize);
    window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; spawnCursorTrail(); });
    for(let i=0; i<6; i++) nebulaLayers.push({ x: Math.random()*w, y: Math.random()*h, r: Math.random()*300+300, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5, c: Math.floor(Math.random()*(currentNebulaColors.length-1)+1) });
    for(let i=0; i<200; i++) stars.push({ x: Math.random()*w, y: Math.random()*h, s: Math.random()*2, a: Math.random(), vx: (Math.random()-0.5)*0.1, vy: (Math.random()-0.5)*0.1 });
    loopVisuals();
}
function resize() { w = window.innerWidth; h = window.innerHeight; bgCanvas.width = cursorCanvas.width = pCanvas.width = w; bgCanvas.height = cursorCanvas.height = pCanvas.height = h; }
function spawnCursorTrail() { for(let i=0; i<2; i++) cursorParticles.push({ x: mouse.x, y: mouse.y, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2, life: 1, c: currentPrimaryColor, s: Math.random()*3+1 }); }

function loopVisuals() {
    if (document.body.classList.contains('clean-mode')) { requestAnimationFrame(loopVisuals); return; }
    bgCtx.fillStyle = currentNebulaColors[0]; bgCtx.fillRect(0,0,w,h);
    nebulaLayers.forEach(l => {
        l.x+=l.vx; l.y+=l.vy; if(l.x<-l.r)l.x=w+l.r; if(l.x>w+l.r)l.x=-l.r; if(l.y<-l.r)l.y=h+l.r; if(l.y>h+l.r)l.y=-l.r;
        let g = bgCtx.createRadialGradient(l.x,l.y,0,l.x,l.y,l.r); g.addColorStop(0, hexToRgba(currentNebulaColors[l.c]||currentNebulaColors[1],0.2)); g.addColorStop(1,'transparent');
        bgCtx.globalCompositeOperation='lighter'; bgCtx.fillStyle=g; bgCtx.beginPath(); bgCtx.arc(l.x,l.y,l.r,0,Math.PI*2); bgCtx.fill();
    });
    bgCtx.globalCompositeOperation='source-over';
    stars.forEach(s => { s.x+=s.vx; s.y+=s.vy; if(s.x<0)s.x=w; if(s.x>w)s.x=0; if(s.y<0)s.y=h; if(s.y>h)s.y=0; s.a+=(Math.random()-0.5)*0.02; if(s.a<0)s.a=0; if(s.a>1)s.a=1; bgCtx.fillStyle=`rgba(255,255,255,${s.a})`; bgCtx.beginPath(); bgCtx.arc(s.x,s.y,s.s,0,Math.PI*2); bgCtx.fill(); });
    cCtx.clearRect(0,0,w,h); cursorParticles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.life-=0.05; p.s*=0.9; if(p.life>0){ cCtx.globalAlpha=p.life; cCtx.fillStyle=p.c; cCtx.beginPath(); cCtx.arc(p.x,p.y,p.s,0,Math.PI*2); cCtx.fill(); } else cursorParticles.splice(i,1); });
    requestAnimationFrame(loopVisuals);
}
function hexToRgba(hex,a) { let r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`; }

window.onload = function() { 
    checkUrlParams(); 
    initVisuals(); 
};
</script>
</body>
</html>
