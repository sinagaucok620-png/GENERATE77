<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHEDULER V40 - 4+1 PATTERN SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="roleBadge" class="role-badge" style="display:none;">
  <span class="role-dot"></span>
  <span id="roleBadgeText">DESIGNER MODE</span>
</div>





<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; flex-direction:column; justify-content:center; align-items:center;">
    <i class="fas fa-circle-notch fa-spin" style="font-size:40px; color:var(--accent-gold); margin-bottom:15px;"></i>
    <div style="color:#fff; font-weight:600; letter-spacing:1px;">SYNCING 31 DAYS DATA...</div>
</div>

<div id="customToast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(50px); background:#111; border:1px solid var(--success); color:var(--success); padding:10px 30px; border-radius:50px; font-weight:700; opacity:0; transition:0.3s; z-index:4000;">ACTION SUCCESS</div>

<canvas id="nebula-canvas"></canvas>

<div id="resultModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3 style="color:#fff; margin:0;">ðŸ“‹ PREVIEW HASIL</h3>
        <textarea id="resultText" class="preview-area" readonly></textarea>
        <button class="btn btn-primary" onclick="finalCopy()" style="width:100%; justify-content:center;">SALIN TEKS</button>
    </div>
</div>

<div id="imgModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()" style="width:auto; max-width:400px;">
        <img id="imgDisplay" src="" style="width:100%; border-radius:10px; display:block;">
        <h4 id="imgTitle" style="color:var(--accent-gold); margin:10px 0 0;"></h4>
    </div>
</div>

<div id="dbModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()" style="text-align:left;">
        <h3 style="color:#fff; margin-top:0;">DATABASE HISTORY</h3>
        <div style="max-height:300px; overflow-y:auto; border-top:1px solid #333;">
            <table style="width:100%; font-size:12px; color:#aaa; margin-top:10px;" id="dbTable"></table>
        </div>
    </div>
</div>

<div class="main-wrapper" id="mainApp">
    <div class="header-section">
        <h1 class="header-title">PLATFORM SCHEDULER</h1>
        <div class="header-meta">V40 COMPLETE â€¢ 31 DAYS SYSTEM</div>
    </div>

    <div class="control-dock">
        <div class="dock-left">
            <div class="input-group">
                <i class="fas fa-globe input-icon"></i>
                <select id="profileSelect" onchange="updateUI()">
                    <option value="CAPTAIN77">CAPTAIN77</option>
                    <option value="JAGUAR77">JAGUAR77</option>
                    <option value="INDOPEDIA77">INDOPEDIA77</option>
                    <option value="FUN77">FUN77</option>
                    <option value="PLAY77">PLAY77</option>
                    <option value="MUSTANG77">MUSTANG77</option>
                    <option value="HOLYPLAY17">HOLYPLAY17</option>
                    <option value="INDOFUN17">INDOFUN17</option>
                </select>
            </div>
            <div class="input-group">
                <i class="fas fa-calendar input-icon"></i>
                <input type="date" id="startDateInput" onchange="updateDateDisplay()">
            </div>

            <div class="input-group seed-group">
                <i class="fas fa-hashtag input-icon"></i>
                <input type="text" id="seedInput" inputmode="numeric" placeholder="SEED (opsional)">
            </div>

        </div>
        <div class="dock-right">
            <button class="btn btn-secondary" onclick="toggleSettings()"><i class="fas fa-clock"></i></button>
            <button class="btn btn-secondary" onclick="toggleMode()"><i class="fas fa-adjust"></i></button>
            <button class="btn btn-secondary btn-danger" onclick="hardReset()"><i class="fas fa-bolt"></i></button>
            <button id="genBtn" onclick="initiateSync()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> GENERATE (1 BULAN)</button>
        </div>
    </div>

    <div id="settingsPanel" class="settings-panel">
        <div class="time-grid">
            <div class="time-input-wrap"><label>MIDNIGHT</label><input type="text" id="timeMidnight" value="00:00 - 06:00 WIB"></div>
            <div class="time-input-wrap"><label>SIANG</label><input type="text" id="timeSiang" value="06:00 - 15:00 WIB"></div>
            <div class="time-input-wrap"><label>SORE</label><input type="text" id="timeSore" value="15:00 - 19:00 WIB"></div>
            <div class="time-input-wrap"><label>MALAM</label><input type="text" id="timeMalam" value="19:00 - 00:00 WIB"></div>
        </div>
    </div>

    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px;">
        <button class="btn btn-secondary" onclick="copyWeek()"><i class="fas fa-copy"></i> SALIN SEMUA (TXT)</button>
        <button class="btn btn-secondary" onclick="shareLink()"><i class="fas fa-link"></i> BAGIKAN LINK</button>
        <button class="btn btn-secondary" onclick="showDB()"><i class="fas fa-database"></i> RIWAYAT</button>
    </div>

    <button id="showHistoryBtn" class="history-toggle-btn" onclick="toggleHistory()">
        <i class="fas fa-history"></i> TAMPILKAN HARI YANG SUDAH LEWAT
    </button>

    <div id="outputArea"></div>
</div>

<script>
// --- ROLE MODE (admin/designer) ---
const __params = new URLSearchParams(window.location.search);
const __role = (__params.get('role') || 'admin').toLowerCase();
window.__ROLE__ = __role;

function applyRoleMode(){
  const badge = document.getElementById('roleBadge');
  const badgeTxt = document.getElementById('roleBadgeText');
  if(__role === 'designer'){
    document.body.classList.add('designer-mode');
    if(badge){ badge.style.display = 'flex'; }
    if(badgeTxt){ badgeTxt.textContent = 'DESIGNER MODE (READ ONLY)'; }

    // Disable controls that mutate state
    const genBtn = document.getElementById('genBtn');
    if(genBtn){ genBtn.disabled = true; genBtn.classList.add('is-disabled'); genBtn.title = 'Designer mode: generate dinonaktifkan'; }

    const seed = document.getElementById('seedInput');
    if(seed){ seed.disabled = true; seed.title = 'Designer mode: seed dikunci'; }

    const resetBtn = document.querySelector('.btn-danger');
    if(resetBtn){ resetBtn.disabled = true; resetBtn.title = 'Designer mode: reset dinonaktifkan'; }

    // Prevent deleting items (also enforced in deleteItem())
    // Hide delete buttons via CSS (designer-mode).
  } else {
    if(badge){ badge.style.display = 'none'; }
  }
}

// --- CONFIG ---
const PROFILE_CONFIG = {
    "CAPTAIN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=0&single=true&output=csv",
    "JAGUAR77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1165225864&single=true&output=csv",
    "INDOPEDIA77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=288756155&single=true&output=csv",
    "FUN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=7296733&single=true&output=csv",
    "PLAY77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=410917478&single=true&output=csv",
    "MUSTANG77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1769820056&single=true&output=csv",
    "HOLYPLAY17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=265631998&single=true&output=csv",
    "INDOFUN17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=2086618792&single=true&output=csv"
};
const THEMES = { "CAPTAIN77": { main: "#00f2ff" }, "PLAY77": { main: "#3b82f6" }, "JAGUAR77": { main: "#FFD700" }, "FUN77": { main: "#ff3e3e" }, "INDOPEDIA77": { main: "#4ade80" }, "INDOFUN17": { main: "#ff0055" }, "HOLYPLAY17": { main: "#d8b4fe" }, "MUSTANG77": { main: "#00ff88" } };
const FIXES = { "Olympus":"Gates of Olympus", "Starlight":"Starlight Princess", "Inces":"Starlight Princess" };
const BLACKLIST = ["Game Error", "Slot Demo"];

let currentSeed = Date.now();
let rnd = Math.random;
// V40: Menambahkan array 'buys' khusus di dalam poolPP
let poolPP={gold:[],silver:[],bronze:[],guide:[],buys:[]}, poolPG={gold:[],silver:[],bronze:[],guide:[]};
let gameImgs={}, depoData={"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]}, globalData=[];
let codePool = []; let globalGenID = 0; let deletedIDs = new Set(); 

function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
function shuffle(a) { let c=a.length,r; while(c!=0){ r=Math.floor(rnd()*c); c--; [a[c],a[r]]=[a[r],a[c]]; } return a; }

function initiateSync() {
    if (window.__ROLE__ === 'designer') { return showToast('DESIGNER MODE: GENERATE DINONAKTIFKAN'); }
 
    // Prioritas seed: input admin > seed di URL (kalau ada) > random
    const seedEl = document.getElementById('seedInput');
    const inputSeedRaw = (seedEl && seedEl.value) ? seedEl.value.trim() : '';
    const urlParams = new URLSearchParams(location.search);
    const urlSeedRaw = urlParams.get('seed') ? String(urlParams.get('seed')).trim() : '';

    let chosen = '';
    if (inputSeedRaw) chosen = inputSeedRaw;
    else if (urlSeedRaw) chosen = urlSeedRaw;

    // Normalisasi: kalau bukan angka, ubah jadi hash sederhana
    if (chosen) {
        const asNum = parseInt(chosen, 10);
        if (!Number.isNaN(asNum)) currentSeed = asNum;
        else {
            // hash string â†’ int 32-bit
            let h = 2166136261;
            for (let i = 0; i < chosen.length; i++) { h ^= chosen.charCodeAt(i); h = Math.imul(h, 16777619); }
            currentSeed = (h >>> 0);
        }
    } else {
        currentSeed = Date.now();
    }

    rnd = mulberry32(currentSeed);
    deletedIDs.clear();
    updateUrlState();
    fetchData();
}

async function fetchData() {
    const prof = document.getElementById('profileSelect').value;
    const btn = document.getElementById('genBtn');
    document.getElementById('loadingOverlay').style.display='flex';
    btn.disabled = true;

    try {
        const cacheKey = "csv_cache_" + prof;
        const cacheTsKey = "csv_cache_ts_" + prof;

        let txt = "";
        try {
            const res = await fetch(PROFILE_CONFIG[prof], { cache: "no-store" });
            if (!res.ok) throw new Error("HTTP " + res.status);
            txt = await res.text();
            localStorage.setItem(cacheKey, txt);
            localStorage.setItem(cacheTsKey, String(Date.now()));
        } catch(fetchErr) {
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                txt = cached;
                const ts = Number(localStorage.getItem(cacheTsKey) || "0");
                const d = ts ? new Date(ts) : null;
                showToast("SPREADSHEET ERROR â€” PAKAI CACHE" + (d ? (" (" + d.toLocaleString('id-ID') + ")") : ""));
            } else {
                throw fetchErr;
            }
        }
        const rows = txt.split(/\r?\n/).filter(r=>r.trim()!=='');

        // Reset Pools
        poolPP={gold:[],silver:[],bronze:[],guide:[],buys:[]}; poolPG={gold:[],silver:[],bronze:[],guide:[]};
        gameImgs={}; depoData={"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]};

        rows.slice(1).forEach(r => {
            // FIX PARSING V40: Replace quote sebelum split agar aman
            let c = r.replace(/"/g,'').split(','); if(c.length<3) return;
            let p=c[0].trim().toLowerCase(), tier=c[1].trim().toUpperCase(), n=c[2].trim(), meta=(c[3]||"").replace(/\*\*/g,'');
            if(BLACKLIST.includes(n)) return;
            if(FIXES[n]) n = FIXES[n];
            if(!n || n==='GameName') return;

            if(p.includes('setting') && tier.startsWith('DEPO_')) {
                let s = tier.replace('DEPO_','');
                if(depoData[s]) depoData[s].push({range:n, info:meta});
            } else {
                if(meta) gameImgs[n]=meta;
                let t = c[1].trim().toLowerCase();
                if(p.includes('pragmatic')) { 
                    if(t==='guide') {
                        // V40 LOGIC: PEMISAHAN OTOMATIS BUYSPIN
                        // Jika kalimat mengandung "BUY" atau "BELI", masukkan ke laci khusus
                        if(n.toUpperCase().includes('BUY') || n.toUpperCase().includes('BELI')) {
                            poolPP.buys.push(n);
                        } else {
                            poolPP.guide.push(n);
                        }
                    } 
                    else if(poolPP[t]) poolPP[t].push(n); 
                }
                else if(p.includes('pg')||p.includes('soft')) { 
                    if(t==='guide') poolPG.guide.push(n); 
                    else if(poolPG[t]) poolPG[t].push(n); 
                }
            }
        });

        generateSchedule(prof);
        
        let db = JSON.parse(localStorage.getItem('dbHistory')||"[]");
        db.unshift({id:Date.now(), seed:currentSeed, prof:prof, date:document.getElementById('startDateInput').value});
        if(db.length>30) db.pop();
        localStorage.setItem('dbHistory',JSON.stringify(db));

        document.getElementById('loadingOverlay').style.display='none';
        btn.disabled = false;
        showToast("DATA 31 HARI BERHASIL");
        checkPastDays(); setTimeout(scrollToToday, 500);

    } catch(e) {
        document.getElementById('loadingOverlay').style.display='none';
        btn.disabled = false;
        showToast("GAGAL MENGAMBIL DATA DARI SPREADSHEET");
    }
}

function generateSchedule(prof) {
    let date = new Date(document.getElementById('startDateInput').value);
    let times = { "MIDNIGHT": document.getElementById('timeMidnight').value, "SIANG": document.getElementById('timeSiang').value, "SORE": document.getElementById('timeSore').value, "MALAM": document.getElementById('timeMalam').value };
    let days = ["MINGGU","SENIN","SELASA","RABU","KAMIS","JUMAT","SABTU"];
    let html = "";
    globalData = []; codePool = []; globalGenID = 0; 
    let today = new Date(); today.setHours(0,0,0,0);
    
    // Matrix Memory untuk 31 Hari (Cooldown)
    let historyMatrix = []; 

    let historyThemeMatrix = [];
    // Loop 31 Hari
    for(let i=0; i<31; i++) {
        let d = new Date(date); d.setDate(date.getDate()+i);
        let checkDate = new Date(d); checkDate.setHours(0,0,0,0);
        let dStr = d.toLocaleDateString('id-ID', {day:'2-digit', month:'2-digit'});
        let dName = days[d.getDay()];
        
        let dayObj = {day:dName, date:dStr, sessions:[]};
        let dailyGames = []; 
        let gamesThisDay = []; 

        let dayThemesUsed = [];
        let isPast = checkDate < today;
        let isToday = checkDate.getTime() === today.getTime();
        let dayClass = isPast ? 'day-past' : (isToday ? 'today-highlight' : '');
        let idAttr = isToday ? 'id="todayRow"' : '';

        html += `<div class="day-section ${dayClass}" ${idAttr}><div class="day-title">${dName} <span class="date-badge">${dStr}</span><span class="today-badge">AKTIF SEKARANG</span></div><div class="session-grid">`;

        let sessions = ["MIDNIGHT","SIANG","SORE","MALAM"];
        let currentSessThemes = [];
        let yesterdayThemes = {"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]}; 

        sessions.forEach(sess => {
            let counts = resolveGameCounts(prof, sess);
            let sHtml = "", rawTxt = "";
            let dayThemesUsedLocal = [...dayThemesUsed];
            currentSessThemes = [];

            const draw = (pool, tier) => {
                let res = pickGame(pool, tier, dailyGames, dayThemesUsedLocal, currentSessThemes, i, historyMatrix, historyThemeMatrix);
                
                if(res.name !== "NO DATA") {
                    dailyGames.push(res.name);
                    gamesThisDay.push(res.name); 
                    currentSessThemes.push(res.theme);
                    if(res.theme) dayThemesUsedLocal.push(res.theme);
                }
                let uid = globalGenID++; 
                
                let manualLink = gameImgs[res.name];
                let finalImg;
                if (manualLink && manualLink.length > 3) { finalImg = manualLink; } 
                else { let safeName = res.name.toLowerCase().replace(/ /g, '_'); finalImg = "img/" + safeName + ".jpg"; }

                return {
                    name: res.name,
                    html: `<div class="game-item" id="gid-${uid}" onclick="showImg('${res.name}', '${finalImg}')">
                            <img src="${finalImg}" class="game-icon" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=IMG';">
                            <div class="game-info-wrap"><span class="g-name">${res.name}</span><span class="g-tag tag-${tier}">${tier}</span></div>
                            <button class="del-btn-overlay" onclick="deleteItem('${uid}', event)">âœ•</button></div>`
                };
            };

            if(counts.pp > 0) {
                sHtml += `<div class="prov-label">PRAGMATIC PLAY</div>`; rawTxt += `--- PRAGMATIC PLAY ---\n`;
                for(let k=0; k<counts.pp; k++) { let t = (sess==="SORE")?'gold':(k===0?'gold':(k===1?'silver':'bronze')); let r = draw(poolPP, t); sHtml += r.html; rawTxt += r.name + '\n'; }
                let pt = getPattern(poolPP, 'Pragmatic'); sHtml += pt.html; rawTxt += `POLA:\n${pt.txt}\n`;
            }
            if(counts.pg > 0) {
                sHtml += `<div class="prov-label">PG SOFT</div>`; rawTxt += `--- PG SOFT ---\n`;
                for(let k=0; k<counts.pg; k++) { let t = (sess==="SORE")?'gold':(k===0?'gold':'silver'); let r = draw(poolPG, t); sHtml += r.html; rawTxt += r.name + '\n'; }
                let pt = getPattern(poolPG, 'PGSoft'); sHtml += pt.html; rawTxt += `POLA:\n${pt.txt}\n`;
            }

            dayThemesUsed = dayThemesUsedLocal;

            let dep = getDeposit(sess, prof);
            dayObj.sessions.push({title:sess, time:times[sess], content:rawTxt, depo:dep});
            html += `<div class="card"><div class="card-header"><div><div class="sess-name">${sess}</div><span class="sess-time">${times[sess]}</span></div><button class="copy-mini" onclick="copyOne(${i}, ${dayObj.sessions.length-1})"><i class="fas fa-copy"></i></button></div><div class="card-body" id="sess-${i}-${sess}">${sHtml}<div class="depo-box"><div class="depo-code">KODE UNIK: ${dep.code}</div>${dep.html}</div></div></div>`;
        });

        html += `</div></div>`;
        globalData.push(dayObj);
        historyMatrix.push(gamesThisDay);
        historyThemeMatrix.push(Array.from(new Set(dayThemesUsed)));
    }
    
    document.getElementById('outputArea').innerHTML = html;
    applyDeletions(); 
}

function pickGame(pool, tier, dailyGames, dayThemesUsed, currentSessThemes, dayIndex, historyMatrix, historyThemeMatrix) {
    // Tier semantics (Rasdip):
    // GOLD   = game utama / wajib keluar -> boleh override cooldown theme 2 hari (tetap hindari duplikat dalam 1 sesi & duplikat nama dalam 1 hari sebisa mungkin)
    // SILVER = game pendamping -> patuh cooldown + anti-theme harian
    // BRONZE = game terbaru -> patuh ketat + prefer rotasi (lebih sulit diulang)

    // Fallback jika tier list kosong
    const listForTier = (t) => (pool && pool[t]) ? pool[t] : [];
    let fullList = listForTier(tier);
    if (!fullList || fullList.length === 0) {
        // fallback ke tier lain (agar tidak NO DATA)
        if (tier === 'bronze') fullList = listForTier('silver').concat(listForTier('gold'));
        else if (tier === 'silver') fullList = listForTier('gold').concat(listForTier('bronze'));
        else fullList = listForTier('silver').concat(listForTier('bronze'));
    }
    if (!fullList || fullList.length === 0) return { name: "NO DATA", theme: "" };

    const themeOf = (g) => getTheme(g);

    const isCoolingDownGame = (gameName) => {
        if (dayIndex > 0 && historyMatrix[dayIndex-1] && historyMatrix[dayIndex-1].includes(gameName)) return true;
        if (dayIndex > 1 && historyMatrix[dayIndex-2] && historyMatrix[dayIndex-2].includes(gameName)) return true;
        return false;
    };

    const isCoolingDownTheme = (theme) => {
        if (!theme) return false;
        if (dayIndex > 0 && historyThemeMatrix[dayIndex-1] && historyThemeMatrix[dayIndex-1].includes(theme)) return true;
        if (dayIndex > 1 && historyThemeMatrix[dayIndex-2] && historyThemeMatrix[dayIndex-2].includes(theme)) return true;
        return false;
    };

    // Rule sets by tier
    const rules = {
        gold: {
            avoidThemeCooldown: true,   // override
            avoidDayThemeRepeat: true,  // still prefer not repeating theme within same day if possible
            avoidDayGameRepeat: true,   // avoid same game within same day
            avoidGameCooldown: true,    // prefer avoid if possible, but can override
            strictSessionTheme: true
        },
        silver: {
            avoidThemeCooldown: true,
            avoidDayThemeRepeat: true,
            avoidDayGameRepeat: true,
            avoidGameCooldown: true,
            strictSessionTheme: true
        },
        bronze: {
            avoidThemeCooldown: true,
            avoidDayThemeRepeat: true,
            avoidDayGameRepeat: true,
            avoidGameCooldown: true,
            strictSessionTheme: true
        }
    };

    // For GOLD: cooldown can be overridden if pool is tight.
    // For SILVER/BRONZE: keep strict as before, but allow graceful fallback.
    const tierKey = (tier === 'gold' || tier === 'silver' || tier === 'bronze') ? tier : 'silver';
    const cfg = rules[tierKey];

    // strict levels:
    // 4 = cooldown 2 hari (game+theme) + anti-theme harian + anti-game harian
    // 3 = anti-theme harian + anti-game harian
    // 2 = anti-game harian
    // 1 = session theme unique only
    const isValid = (g, strictLevel) => {
        const theme = themeOf(g);

        // Always: in-session theme must be unique (best UX)
        if (cfg.strictSessionTheme && currentSessThemes.includes(theme)) return false;

        // Avoid same game in same day (if requested)
        if (cfg.avoidDayGameRepeat && strictLevel >= 2) {
            if (dailyGames.includes(g)) return false;
        }

        // Avoid repeating theme within same day across sessions (if requested)
        if (cfg.avoidDayThemeRepeat && strictLevel >= 3) {
            if (dayThemesUsed.includes(theme)) return false;
        }

        // Cooldown 2 days: theme + game
        if (strictLevel >= 4) {
            if (cfg.avoidGameCooldown && isCoolingDownGame(g)) return false;
            if (cfg.avoidThemeCooldown && isCoolingDownTheme(theme)) return false;
        }

        return true;
    };

    // Candidate selection:
    // SILVER/BRONZE: try strict, then relax gradually.
    // GOLD: try strict, but relax more aggressively (never return NO DATA if possible).
    let candidates = [];
    const startLevel = 4;
    const endLevel = 1;

    for (let level = startLevel; level >= endLevel; level--) {
        candidates = fullList.filter(g => isValid(g, level));
        if (candidates.length > 0) break;
    }

    // Extra relax for GOLD only: ignore daily theme repeat, then ignore daily game repeat.
    if ((tierKey === 'gold') && candidates.length === 0) {
        candidates = fullList.filter(g => {
            const theme = themeOf(g);
            if (currentSessThemes.includes(theme)) return false;
            // allow repeats if needed
            return true;
        });
    }

    if (candidates.length === 0) candidates = fullList;

    // BRONZE weighting: prefer items not seen in last 2 days & not in dayThemesUsed (already filtered),
    // so here we just add a small bias to pick earlier in list after shuffle for extra rotation.
    let picked;
    if (tierKey === 'bronze' && candidates.length > 3) {
        // shuffle then pick from first half more often
        const tmp = candidates.slice();
        shuffle(tmp);
        const half = Math.max(2, Math.floor(tmp.length * 0.5));
        picked = tmp[Math.floor(rnd() * half)];
    } else {
        picked = candidates[Math.floor(rnd() * candidates.length)];
    }

    return { name: picked, theme: themeOf(picked) };
}

function getTheme(gameName) {
    // Theme = "keluarga/tema besar" yang dipakai untuk aturan anti-theme berulang.
    // Tujuan: variasi judul (Deluxe/Gold/1000/versi dll) tetap dianggap 1 tema.
    let n = (gameName || "").toLowerCase();

    // buang kata-kata umum yang sering jadi embel-embel judul
    n = n.replace(/\b(1000|megaways|maxways|xmas|christmas|jackpot|deluxe|super|scatter|party|gold|silver|bronze|tournament|free|spin|spins|wild|bonus|mania|rush)\b/g, " ");
    n = n.replace(/[0-9]+/g, " ");
    n = n.replace(/[^a-z\s]/g, " ");
    n = n.replace(/\s+/g, " ").trim();

    // Mapping tema besar (bisa kamu tambah kapan saja)
    // Format: kalau mengandung keyword -> return themeKey
    const THEME_MAP = [
        { key: "starlight",  words: ["starlight", "inces", "princess"] },
        { key: "olympus",    words: ["olympus", "zeus", "gates of olympus"] },
        { key: "gatot",      words: ["gatot", "gatotkaca"] },
        { key: "bonanza",    words: ["bonanza", "sweet bonanza", "candy"] },
        { key: "mahjong",    words: ["mahjong"] },
        { key: "poseidon",   words: ["poseidon"] },
        { key: "aztec",      words: ["aztec"] },
        { key: "pirate",     words: ["pirate", "pirates"] },
        { key: "dragon",     words: ["dragon", "dragons"] },
        { key: "samurai",    words: ["samurai"] },
        { key: "egypt",      words: ["egypt", "pharaoh", "anubis", "cleopatra"] },
        { key: "viking",     words: ["viking", "valhalla", "ragnarok", "thor"] },
        { key: "wildwest",   words: ["wild west", "cowboy", "outlaw"] },
        { key: "buffalo",    words: ["buffalo", "bison"] },
        { key: "fortune",    words: ["fortune"] },
        { key: "joker",      words: ["joker"] },
        { key: "kraken",     words: ["kraken"] },
        { key: "midas",      words: ["midas"] },
    ];

    for (const t of THEME_MAP) {
        for (const w of t.words) {
            if (n.includes(w)) return t.key;
        }
    }

    // Fallback: pakai 1-2 kata pertama sebagai tema
    const parts = n.split(" ").filter(Boolean);
    if (parts.length === 0) return "";
    if (parts.length === 1) return parts[0];
    return parts[0] + "_" + parts[1];
}

// --- V40 FIXED PATTERN LOGIC ---
function getPattern(poolObj, prov) {
    // poolObj sekarang adalah objek penuh (poolPP/poolPG) bukan cuma list guide
    let list = poolObj.guide;
    if(!list || list.length===0) return {html:"", txt:""};
    
    let sel = [], txt = "";
    
    // Pragmatic: 4 baris pola daun
    // PG Soft: 5 baris pola daun
    let loopCount = (prov === 'Pragmatic') ? 4 : 5;
    let type = s => s.toUpperCase().includes('MANUAL')?'M':(s.toUpperCase().includes('AUTO')?'A':'T');
    
    for(let i=0; i<loopCount; i++) {
        let last = sel.length>0 ? type(sel[sel.length-1]) : null;
        let pool = list.filter(x => type(x)!==last && !sel.includes(x));
        if(pool.length===0) pool=list;
        sel.push(pool[Math.floor(rnd()*pool.length)]);
    }

    // V40 LOGIC: BUYSPIN PASTI DIAMBIL DARI LACI 'poolPP.buys' UNTUK PRAGMATIC
    if(prov==='Pragmatic') {
        let buyText;
        if(poolObj.buys && poolObj.buys.length > 0) {
            // Ambil dari laci khusus yang sudah dipisahkan saat load data
            buyText = poolObj.buys[Math.floor(rnd() * poolObj.buys.length)];
        } else {
            // Fallback jika sheet benar-benar kosong
            buyText = "BUY SPIN SECUKUPNYA";
        }
        sel.push(buyText);
    }

    let dcHtml = "";
    if(prov === 'Pragmatic') {
        let state = rnd() > 0.5 ? "ON" : "OFF";
        dcHtml = `<span style="background:var(--accent-gold); color:#000; padding:2px 6px; border-radius:4px; font-size:9px; font-weight:800; display:inline-block; margin-bottom:5px;">FITUR GANDA ${state}</span>`;
    }

    let h = `<div class="pattern-box"><div style="font-size:9px;color:var(--accent-gold);font-weight:800;margin-bottom:5px;">BET NOMINAL BEBAS</div>${dcHtml}`;
    sel.forEach(s => {
        let uid = globalGenID++;
        h += `<div class="pt-row" id="gid-${uid}"><span class="pt-txt">${s}</span><button class="del-btn-overlay" onclick="deleteItem('${uid}', event)">âœ•</button></div>`;
        txt += `> ${s}\n`;
    });
    h += `<div style="text-align:center;font-size:9px;color:#888;margin-top:5px;">NAIKAN BET BERTAHAP & ULANGI POLANYA</div></div>`;
    txt += `NAIKAN BET BERTAHAP & ULANGI POLANYA`;
    return {html:h, txt:txt};
}

// --- UTILS ---
function resolveGameCounts(profile, sessionName) { const r = rnd(); if (profile === "CAPTAIN77") { if(sessionName === "MIDNIGHT") return { pp:3, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return { pp:2, pg:0 }; if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 }; } else if (profile === "JAGUAR77") { if(sessionName === "MIDNIGHT") return { pp:3, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:1 }; if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 }; } else if (profile === "FUN77") { if(sessionName === "MIDNIGHT") return { pp:3, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:0 }; if(sessionName === "MALAM") return { pp:1, pg:1 }; } else if (profile === "MUSTANG77") { if(sessionName === "MIDNIGHT") return { pp:2, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return { pp:1, pg:0 }; if(sessionName === "MALAM") return { pp:0, pg:1 }; } else if (profile === "INDOPEDIA77") { if(sessionName === "MIDNIGHT") return { pp:2, pg:2 }; if(sessionName === "SIANG") return { pp:3, pg:3 }; if(sessionName === "SORE") return r > 0.5 ? { pp:1, pg:0 } : { pp:2, pg:0 }; if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 }; } else if (profile === "HOLYPLAY17") { if(sessionName === "MIDNIGHT") return { pp:2, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return { pp:2, pg:0 }; if(sessionName === "MALAM") return { pp:0, pg:2 }; } else if (profile === "INDOFUN17") { if(sessionName === "MIDNIGHT") return { pp:2, pg:2 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") return { pp:2, pg:0 }; if(sessionName === "MALAM") return { pp:0, pg:1 }; } else if (profile === "PLAY77") { if(sessionName === "MIDNIGHT") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:0 }; if(sessionName === "SIANG") return { pp:2, pg:2 }; if(sessionName === "SORE") { if (r < 0.33) return { pp:1, pg:0 }; else if (r < 0.66) return { pp:2, pg:0 }; else return { pp:1, pg:1 }; } if(sessionName === "MALAM") return { pp:0, pg:1 }; } return { pp:2, pg:2 }; }
function getDeposit(sess, prof) { if(codePool.length===0) { codePool=[1000,2000,3000,4000,5000,6000,7000,8000,9000]; shuffle(codePool); } let code = codePool.pop() || 1000; let raw = depoData[sess] || []; if(prof==="FUN77") raw = raw.slice(0,1); if(raw.length===0) return {code:code, html:"", text:""}; let h="", t=""; raw.forEach((d,i) => { let r = d.range.split('-'); let v1 = parseInt(r[0].replace(/\D/g,'')) + code; let v2 = r[1] ? parseInt(r[1].replace(/\D/g,'')) + code : null; let s = `Rp ${v1.toLocaleString()}` + (v2?` - Rp ${v2.toLocaleString()}`:''); let info = d.info.split('|'); h += `<div class="depo-row"><span>${i+1}. ${s}</span><span style="color:var(--accent-gold)">${info[0]||''}</span></div>`; t += `${i+1}. ${s} (${info[0]||''})\n`; }); return {code:code, html:h, text:t}; }
function deleteItem(uid, e) {
    if (window.__ROLE__ === 'designer') { showToast('DESIGNER MODE: TIDAK BISA HAPUS'); return; }
 if(e) e.stopPropagation(); const el = document.getElementById('gid-' + uid); if(el) { el.style.opacity = '0'; setTimeout(() => el.remove(), 200); deletedIDs.add(uid.toString()); updateUrlState(); } }
function applyDeletions() { deletedIDs.forEach(uid => { const el = document.getElementById('gid-' + uid); if(el) el.remove(); }); }
function updateUrlState() { let u = new URL(location.href); u.searchParams.set('seed', currentSeed); u.searchParams.set('profile', document.getElementById('profileSelect').value); u.searchParams.set('date', document.getElementById('startDateInput').value); u.searchParams.set('tM', document.getElementById('timeMidnight').value); u.searchParams.set('tSi', document.getElementById('timeSiang').value); u.searchParams.set('tSo', document.getElementById('timeSore').value); u.searchParams.set('tMa', document.getElementById('timeMalam').value); if(deletedIDs.size > 0) u.searchParams.set('del', Array.from(deletedIDs).join(',')); else u.searchParams.delete('del'); history.replaceState(null, '', u); }
function updateUI() { let p = document.getElementById('profileSelect').value; document.documentElement.style.setProperty('--accent-gold', THEMES[p]?.main || '#D4AF37'); }
function updateDateDisplay() {} 
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('active'); }
function toggleMode() { document.body.classList.toggle('clean-mode'); }
function hardReset() {
    if (window.__ROLE__ === 'designer') { return showToast('DESIGNER MODE: RESET DINONAKTIFKAN'); }
 if(confirm("Refresh System & Clear Cache?")) { localStorage.clear(); location.href = location.pathname; } }
function showImg(n, url) { let finalUrl = url || 'https://via.placeholder.com/400x250?text=NO+IMAGE'; document.getElementById('imgDisplay').src = finalUrl; document.getElementById('imgTitle').innerText = n; document.getElementById('imgModal').style.display='flex'; }
function showToast(m) { let t=document.getElementById('customToast'); t.innerText=m; t.classList.add('active'); setTimeout(()=>t.classList.remove('active'),3000); }
function checkPastDays() { let pastItems = document.querySelectorAll('.day-past'); let btn = document.getElementById('showHistoryBtn'); if(pastItems.length > 0) { btn.style.display = 'block'; btn.innerHTML = `<i class="fas fa-history"></i> ${pastItems.length} HARI YANG LALU DISEMBUNYIKAN (KLIK UNTUK LIHAT)`; } else { btn.style.display = 'none'; } }
function toggleHistory() { let pastItems = document.querySelectorAll('.day-past'); pastItems.forEach(el => { el.style.display = (el.style.display === 'block') ? '' : 'block'; }); }
function scrollToToday() { const el = document.getElementById('todayRow'); if(el) { el.scrollIntoView({behavior: "smooth", block: "center"}); showToast("JADWAL HARI INI DITEMUKAN"); } }
function showDB() { let db = JSON.parse(localStorage.getItem('dbHistory')||"[]"); let h=""; db.forEach(x => { let d=new Date(x.id); h += `<tr><td style="padding:8px;border-bottom:1px solid #333;">${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td><td style="padding:8px;border-bottom:1px solid #333;color:var(--accent-gold)">${x.prof}</td><td style="padding:8px;border-bottom:1px solid #333;"><a href="?seed=${x.seed}&profile=${x.prof}&date=${x.date}" style="color:#aaa;">LOAD</a></td></tr>`; }); document.getElementById('dbTable').innerHTML=h; document.getElementById('dbModal').style.display='flex'; }
function extractDOM(dom) { let txt = ""; dom.querySelectorAll('.prov-label, .game-item, .pattern-box').forEach(el => { if(el.classList.contains('prov-label')) txt += `\n--- ${el.innerText} ---\n`; if(el.classList.contains('game-item')) txt += `${el.querySelector('.g-name').innerText}\n`; if(el.classList.contains('pattern-box')) { txt += "POLA:\n"; el.querySelectorAll('.pt-txt').forEach(p => txt += `> ${p.innerText}\n`); txt += "NAIKAN BET BERTAHAP\n"; } }); return txt; }
function copyOne(d, s) { let data = globalData[d].sessions[s]; let dom = document.getElementById(`sess-${d}-${data.title}`); let content = extractDOM(dom); let final = `=================================\nHARI: ${globalData[d].day}, ${globalData[d].date}\nSESI: ${data.title} (${data.time})\n=================================\n${content}\n---------------------------------\nKODE UNIK: ${data.depo.code}\n---------------------------------\n${data.depo.text}`; document.getElementById('resultText').value = final; document.getElementById('resultModal').style.display='flex'; }
function copyWeek() { if(globalData.length===0) return showToast("DATA KOSONG"); let t = `JADWAL LENGKAP 1 BULAN\nPERIODE: ${document.getElementById('startDateInput').value}\n\n`; globalData.forEach((d,i) => { t += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“… ${d.day}, ${d.date}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`; d.sessions.forEach((s, idx) => { let dom = document.getElementById(`sess-${i}-${s.title}`); t += `\n[ ${s.title} | ${s.time} ]\n${extractDOM(dom)}\n------------------------------\nKODE: ${s.depo.code}\n`; }); t += '\n\n'; }); document.getElementById('resultText').value = t; document.getElementById('resultModal').style.display='flex'; }
function finalCopy() { document.getElementById('resultText').select(); document.execCommand('copy'); showToast("BERHASIL DISALIN!"); }
function shareLink() { updateUrlState(); navigator.clipboard.writeText(location.href).then(() => showToast("LINK TERSIMPAN!")); }
function initLoad() { let p = new URLSearchParams(location.search); if(p.get('tM')) document.getElementById('timeMidnight').value = p.get('tM'); if(p.get('tSi')) document.getElementById('timeSiang').value = p.get('tSi'); if(p.get('tSo')) document.getElementById('timeSore').value = p.get('tSo'); if(p.get('tMa')) document.getElementById('timeMalam').value = p.get('tMa'); if(p.get('del')) p.get('del').split(',').forEach(id => deletedIDs.add(id));  
    if(p.get('seed')) { 
        currentSeed = parseInt(p.get('seed')); 
        if (Number.isNaN(currentSeed)) currentSeed = Date.now();
        rnd = mulberry32(currentSeed); 
        if (document.getElementById('seedInput')) document.getElementById('seedInput').value = currentSeed;
        if (p.get('profile')) document.getElementById('profileSelect').value = p.get('profile'); 
        if (p.get('date')) document.getElementById('startDateInput').value = p.get('date'); 
        updateUI(); 
        fetchData(); 
    } else { 
        document.getElementById('startDateInput').valueAsDate = new Date(); 
        if (document.getElementById('seedInput')) document.getElementById('seedInput').value = '';
        initVisuals(); 
    } }
const ctx = document.getElementById('nebula-canvas').getContext('2d'); function initVisuals() { let w=window.innerWidth, h=window.innerHeight; document.getElementById('nebula-canvas').width=w; document.getElementById('nebula-canvas').height=h; let hue=0; function anim() { if(document.body.classList.contains('clean-mode')) return requestAnimationFrame(anim); ctx.fillStyle=`rgba(0,0,0,0.05)`; ctx.fillRect(0,0,w,h); ctx.fillStyle=`hsla(${hue}, 50%, 50%, 0.5)`; ctx.beginPath(); ctx.arc(Math.random()*w, Math.random()*h, Math.random()*2, 0, Math.PI*2); ctx.fill(); hue+=0.5; requestAnimationFrame(anim); } anim(); }
window.onload = () => { document.getElementById("mainApp").style.display = "block"; applyRoleMode(); initLoad(); };
</script>
</body>
</html>
