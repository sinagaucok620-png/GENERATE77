<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCHEDULER V38 - FINAL DRIVE FIX</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-deep: #050505;
            --bg-card: #0F0F0F;
            --accent-gold: #D4AF37; 
            --text-main: #Eaeaea;
            --text-muted: #888888;
            --glass-border: rgba(255, 255, 255, 0.08);
            --danger: #ff4757;
            --success: #00b894;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Outfit', sans-serif; 
            margin: 0; padding: 40px 20px;
            color: var(--text-main); 
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%);
            min-height: 100vh; overflow-x: hidden;
        }

        /* PERFORMANCE BOOSTER */
        .day-section, .card { content-visibility: auto; contain-intrinsic-size: 800px; }

        /* BACKGROUND */
        #nebula-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; pointer-events: none; }
        .main-wrapper { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; display: none; }

        /* HEADER */
        .header-section { text-align: center; margin-bottom: 30px; }
        .header-title {
            font-size: 32px; font-weight: 800; letter-spacing: -1px;
            background: linear-gradient(135deg, #fff 30%, var(--accent-gold) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0; text-transform: uppercase;
        }
        .header-meta { font-size: 11px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 5px;}

        /* CONTROL DOCK */
        .control-dock {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 15px;
            display: flex; flex-wrap: wrap; gap: 10px;
            justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 30px; position: sticky; top: 10px; z-index: 100;
        }
        .dock-left { display: flex; gap: 10px; flex: 1; min-width: 300px; }
        .dock-right { display: flex; gap: 8px; }

        .input-group { position: relative; flex: 1; }
        .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--accent-gold); pointer-events: none; font-size: 12px;}
        
        select, input {
            width: 100%; background: #000; color: #fff;
            border: 1px solid var(--glass-border);
            padding: 10px 10px 10px 35px; border-radius: 8px;
            font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600;
            transition: 0.2s; cursor: pointer;
        }
        select:focus, input:focus { border-color: var(--accent-gold); }

        .btn {
            border: none; padding: 10px 15px; border-radius: 8px;
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 11px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; text-transform: uppercase;
        }
        .btn-primary { background: var(--accent-gold); color: #000; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #ccc; }
        .btn-secondary:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }
        .btn-danger { color: var(--danger); border-color: rgba(255, 77, 77, 0.3); }
        .btn-designer { border-color: var(--accent-gold); color: var(--accent-gold); }
        
        /* SETTINGS */
        .settings-panel { background: var(--bg-card); border: 1px dashed var(--glass-border); padding: 15px; border-radius: 12px; margin-bottom: 20px; display: none; }
        .settings-panel.active { display: block; }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .time-input-wrap label { display: block; font-size: 10px; color: var(--accent-gold); margin-bottom: 3px; font-weight: 700; }

        /* DAY SECTION */
        .day-section { margin-bottom: 30px; padding: 10px; border-radius: 16px; border: 1px solid transparent; }
        .day-section.day-past { display: none; } 
        .day-section.today-highlight { border-color: var(--success); background: rgba(0, 184, 148, 0.03); }
        
        .day-title { font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 10px; border-left: 3px solid var(--accent-gold); padding-left: 10px; display: flex; align-items: center; gap: 10px; }
        .date-badge { font-weight: 400; color: var(--text-muted); font-size: 14px; }
        .today-badge { background: var(--success); color: #000; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 3px; display: none; }
        .today-highlight .today-badge { display: inline-block; }

        .history-toggle-btn {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.03); 
            border: 1px dashed rgba(255,255,255,0.2); color: #888; cursor: pointer; 
            margin-bottom: 20px; border-radius: 12px; font-weight: 700; font-size: 11px; display: none; 
        }

        .session-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .card {
            background: var(--bg-card); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 10px; height: 100%; display: flex; flex-direction: column;
        }
        .today-highlight .card { border-color: rgba(0, 184, 148, 0.3); } 
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sess-name { font-size: 12px; font-weight: 800; color: var(--accent-gold); }
        .sess-time { font-size: 10px; color: var(--text-muted); font-family: monospace; }
        .copy-mini { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #aaa; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 10px; }
        .copy-mini:hover { background: var(--accent-gold); color: #000; }

        /* GRID SYSTEM (3 COLUMN) */
        .prov-section { margin-bottom: 10px; }
        .prov-label { font-size: 9px; font-weight: 800; color: #666; margin-bottom: 5px; letter-spacing: 0.5px; border-bottom: 1px solid #222; display: block; }
        
        .games-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 KOLOM */
            gap: 5px;
            margin-bottom: 6px;
        }

        .game-item-compact {
            background: #151515; 
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px; 
            position: relative; 
            overflow: hidden;
            display: flex; flex-direction: column;
        }
        
        .g-thumb-wrap {
            width: 100%;
            aspect-ratio: 1/1; /* SQUARE */
            background: #000;
            position: relative;
        }
        .g-thumb {
            width: 100%; height: 100%; object-fit: cover; display: block;
            transition: 0.3s;
        }
        .game-item-compact:hover .g-thumb { transform: scale(1.1); }

        .g-info-compact {
            padding: 3px 4px;
            background: #111;
            border-top: 1px solid rgba(255,255,255,0.05);
            text-align: center;
        }
        .g-name-compact { 
            font-size: 8px; font-weight: 600; color: #ddd; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block;
        }

        .g-tag-compact { 
            position: absolute; top: 3px; left: 3px; z-index: 5;
            font-size: 7px; font-weight: 800; padding: 2px 4px; 
            border-radius: 2px; text-transform: uppercase; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .tag-gold { background: #FFD700; color: #000; } .tag-silver { background: #C0C0C0; color: #000; } .tag-bronze { background: #CD7F32; color: #fff; }

        .del-compact {
            position: absolute; right: 2px; top: 2px; 
            width: 16px; height: 16px; border-radius: 3px;
            background: rgba(0, 0, 0, 0.6); color: var(--danger);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 9px; border:none; z-index: 10;
        }
        .del-compact:hover { background: var(--danger); color: #fff; }

        .pattern-box { 
            background: rgba(212, 175, 55, 0.05); 
            border: 1px dashed rgba(212, 175, 55, 0.2); 
            border-radius: 6px; padding: 6px; margin-top: 5px; 
        }
        .pt-row { display: flex; justify-content: space-between; align-items: center; font-size: 9px; color: #aaa; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; padding-right: 20px;}
        .pt-row:last-child { border: none; }
        
        .del-pt { position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: var(--danger); background:none; border:none; cursor:pointer; font-size:9px; display:none; }
        .pt-row:hover .del-pt { display:block; }

        .depo-box { margin-top: auto; padding-top: 8px; border-top: 1px solid #222; }
        .depo-code { text-align: center; font-size: 10px; font-weight: 800; color: var(--accent-gold); margin-bottom: 3px; }
        .depo-row { display: flex; justify-content: space-between; font-size: 9px; color: #666; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; border: 1px solid var(--glass-border); padding: 20px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; }
        .preview-area { width: 100%; height: 200px; background: #000; border: 1px solid #333; color: var(--accent-gold); padding: 10px; border-radius: 8px; font-family: monospace; font-size: 10px; resize: none; margin: 10px 0; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--bg-card); border: 1px solid var(--glass-border); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(212, 175, 55, 0.1); width: 90%; max-width: 400px; }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; background: #000; border: 1px solid #333; color: var(--accent-gold); border-radius: 10px; font-size: 16px; text-align: center; letter-spacing: 2px; }
        .login-btn { background: var(--accent-gold); color: #000; font-weight: 800; padding: 15px; width: 100%; border-radius: 10px; border: none; cursor: pointer; transition: 0.3s; }
        
        body.clean-mode { background: #f4f4f4; color: #222; --bg-card: #fff; --text-main: #222; --text-muted: #666; --glass-border: #ddd; }
        body.clean-mode .control-dock { background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        body.clean-mode input, body.clean-mode select { background: #fff; border-color: #ccc; color: #333; }
        body.clean-mode .card, body.clean-mode .game-item-compact { background: #fff; border-color: #eee; }
        body.clean-mode .g-info-compact { background: #f9f9f9; border-top-color: #eee; }
        body.clean-mode .day-section.today-highlight { background: #e0fbf4; border-color: var(--success); }

        @media(max-width:1024px) { .session-grid { grid-template-columns: repeat(2, 1fr); } }
        @media(max-width:600px) { 
            .session-grid { grid-template-columns: 1fr; } 
            .dock-left, .dock-right { width: 100%; flex-wrap: wrap; } 
            .control-dock { top:0; border-radius: 0; }
            .games-row { grid-template-columns: repeat(3, 1fr); gap: 3px; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:#fff; margin-bottom:5px;">SECURE ACCESS</h2>
        <div style="color:var(--text-muted); font-size:12px; margin-bottom:20px;">SYSTEM V38 DRIVE FIX</div>
        <input type="password" id="passInput" class="login-input" placeholder="ENTER PASSWORD">
        <button onclick="checkLogin()" class="login-btn">UNLOCK SYSTEM</button>
        <div id="loginMsg" style="color:var(--danger); margin-top:15px; font-size:12px;"></div>
    </div>
</div>

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; flex-direction:column; justify-content:center; align-items:center;">
    <i class="fas fa-circle-notch fa-spin" style="font-size:40px; color:var(--accent-gold); margin-bottom:15px;"></i>
    <div style="color:#fff; font-weight:600; letter-spacing:1px;">SYNCING DATA...</div>
</div>

<div id="customToast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(50px); background:#111; border:1px solid var(--success); color:var(--success); padding:8px 25px; border-radius:50px; font-weight:700; opacity:0; transition:0.3s; z-index:4000; font-size:12px;">ACTION SUCCESS</div>

<canvas id="nebula-canvas"></canvas>

<div id="resultModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3 style="color:#fff; margin:0;">ðŸ“‹ PREVIEW HASIL</h3>
        <textarea id="resultText" class="preview-area" readonly></textarea>
        <button class="btn btn-primary" onclick="finalCopy()" style="width:100%; justify-content:center;">SALIN TEKS</button>
    </div>
</div>

<div id="dbModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()" style="text-align:left;">
        <h3 style="color:#fff; margin-top:0;">DATABASE HISTORY</h3>
        <div style="max-height:300px; overflow-y:auto; border-top:1px solid #333;">
            <table style="width:100%; font-size:12px; color:#aaa; margin-top:10px;" id="dbTable"></table>
        </div>
    </div>
</div>

<div class="main-wrapper" id="mainApp">
    <div class="header-section">
        <h1 class="header-title">PLATFORM SCHEDULER</h1>
        <div class="header-meta">V38 â€¢ FINAL DRIVE FIX</div>
    </div>

    <div class="control-dock">
        <div class="dock-left">
            <div class="input-group">
                <i class="fas fa-globe input-icon"></i>
                <select id="profileSelect" onchange="updateUI()">
                    <option value="CAPTAIN77">CAPTAIN77</option>
                    <option value="JAGUAR77">JAGUAR77</option>
                    <option value="INDOPEDIA77">INDOPEDIA77</option>
                    <option value="FUN77">FUN77</option>
                    <option value="PLAY77">PLAY77</option>
                    <option value="MUSTANG77">MUSTANG77</option>
                    <option value="HOLYPLAY17">HOLYPLAY17</option>
                    <option value="INDOFUN17">INDOFUN17</option>
                </select>
            </div>
            <div class="input-group">
                <i class="fas fa-calendar input-icon"></i>
                <input type="date" id="startDateInput" onchange="updateDateDisplay()">
            </div>
        </div>
        <div class="dock-right">
            <button class="btn btn-secondary" onclick="toggleSettings()"><i class="fas fa-clock"></i></button>
            <button class="btn btn-secondary" onclick="toggleMode()"><i class="fas fa-adjust"></i></button>
            <button class="btn btn-secondary btn-designer" onclick="exportForDesigner()"><i class="fas fa-pencil-ruler"></i> BRIEF</button>
            <button class="btn btn-secondary btn-danger" onclick="hardReset()"><i class="fas fa-bolt"></i></button>
            <button id="genBtn" onclick="initiateSync()" class="btn btn-primary"><i class="fas fa-sync-alt"></i> GENERATE</button>
        </div>
    </div>

    <div id="settingsPanel" class="settings-panel">
        <div class="time-grid">
            <div class="time-input-wrap"><label>MIDNIGHT</label><input type="text" id="timeMidnight" value="00:00 - 06:00 WIB"></div>
            <div class="time-input-wrap"><label>SIANG</label><input type="text" id="timeSiang" value="06:00 - 15:00 WIB"></div>
            <div class="time-input-wrap"><label>SORE</label><input type="text" id="timeSore" value="15:00 - 19:00 WIB"></div>
            <div class="time-input-wrap"><label>MALAM</label><input type="text" id="timeMalam" value="19:00 - 00:00 WIB"></div>
        </div>
    </div>

    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px;">
        <button class="btn btn-secondary" onclick="copyWeek()"><i class="fas fa-copy"></i> SALIN MINGGUAN</button>
        <button class="btn btn-secondary" onclick="shareLink()"><i class="fas fa-link"></i> LINK</button>
        <button class="btn btn-secondary" onclick="showDB()"><i class="fas fa-database"></i> RIWAYAT</button>
    </div>

    <button id="showHistoryBtn" class="history-toggle-btn" onclick="toggleHistory()">
        <i class="fas fa-history"></i> TAMPILKAN HARI YANG SUDAH LEWAT
    </button>

    <div id="outputArea"></div>
</div>

<script>
// --- SECURITY (SHA-256) ---
const PASS_HASH = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9"; 

async function checkLogin() {
    const input = document.getElementById('passInput').value;
    const msg = document.getElementById('loginMsg');
    if(!input) return;
    const msgBuffer = new TextEncoder().encode(input);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    if(hashHex === PASS_HASH) {
        document.getElementById('loginOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            initLoad(); 
        }, 500);
        localStorage.setItem('isLoggedIn', 'true');
    } else {
        msg.innerText = "PASSWORD INVALID!";
        document.getElementById('passInput').value = '';
    }
}

if(localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
}

// --- CONFIG ---
const PROFILE_CONFIG = {
    "CAPTAIN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=0&single=true&output=csv",
    "JAGUAR77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1165225864&single=true&output=csv",
    "INDOPEDIA77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=288756155&single=true&output=csv",
    "FUN77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=7296733&single=true&output=csv",
    "PLAY77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=410917478&single=true&output=csv",
    "MUSTANG77": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=1769820056&single=true&output=csv",
    "HOLYPLAY17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=265631998&single=true&output=csv",
    "INDOFUN17": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYLkswRdyQIUIBvcS1-_D6AUqrvqVo9u13KJbMT7aNJXnG8v6wfNMYmivF96G2eHwiSm6I-K64-1qY/pub?gid=2086618792&single=true&output=csv"
};

const THEMES = {
    "CAPTAIN77": { main: "#00f2ff" }, "PLAY77": { main: "#3b82f6" }, "JAGUAR77": { main: "#FFD700" },
    "FUN77": { main: "#ff3e3e" }, "INDOPEDIA77": { main: "#4ade80" }, "INDOFUN17": { main: "#ff0055" },
    "HOLYPLAY17": { main: "#d8b4fe" }, "MUSTANG77": { main: "#00ff88" }
};

const FIXES = { "Olympus":"Gates of Olympus", "Starlight":"Starlight Princess", "Inces":"Starlight Princess" };
const BLACKLIST = ["Game Error", "Slot Demo"];

let currentSeed = Date.now();
let rnd = Math.random;
let poolPP={gold:[],silver:[],bronze:[],guide:[]}, poolPG={gold:[],silver:[],bronze:[],guide:[]};
let gameImgs={}, depoData={"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]}, globalData=[];
let codePool = [];
let globalGenID = 0; 
let deletedIDs = new Set(); 

// --- CORE ---
function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
function seedRandom(s) { return mulberry32(s); }
function shuffle(a) { let c=a.length,r; while(c!=0){ r=Math.floor(rnd()*c); c--; [a[c],a[r]]=[a[r],a[c]]; } return a; }

function initiateSync() {
    currentSeed = Date.now(); 
    rnd = mulberry32(currentSeed);
    deletedIDs.clear(); 
    updateUrlState();   
    fetchData();
}

async function fetchData() {
    const prof = document.getElementById('profileSelect').value;
    const btn = document.getElementById('genBtn');
    document.getElementById('loadingOverlay').style.display='flex';
    btn.disabled = true;

    try {
        // ANTI-CACHE GOOGLE SHEETS
        const res = await fetch(PROFILE_CONFIG[prof] + "&uid=" + Date.now());
        const txt = await res.text();
        const rows = txt.split(/\r?\n/).filter(r=>r.trim()!=='');

        poolPP={gold:[],silver:[],bronze:[],guide:[]}; poolPG={gold:[],silver:[],bronze:[],guide:[]};
        gameImgs={}; depoData={"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]};

        rows.slice(1).forEach(r => {
            let c = r.replace(/"/g,'').split(',');
            if(c.length<3) return;
            let p=c[0].trim().toLowerCase(), tier=c[1].trim().toUpperCase(), n=c[2].trim();
            let meta=(c[3]||"").replace(/\*\*/g,'').trim(); 

            if(BLACKLIST.includes(n)) return;
            if(FIXES[n]) n = FIXES[n];
            if(!n || n==='GameName') return;

            if(p.includes('setting') && tier.startsWith('DEPO_')) {
                let s = tier.replace('DEPO_','');
                if(depoData[s]) depoData[s].push({range:n, info:meta});
            } else {
                if(meta && meta.startsWith('http')) gameImgs[n]=meta; 
                let t = c[1].trim().toLowerCase();
                if(p.includes('pragmatic')) { if(t==='guide') poolPP.guide.push(n); else if(poolPP[t]) poolPP[t].push(n); }
                else if(p.includes('pg')||p.includes('soft')) { if(t==='guide') poolPG.guide.push(n); else if(poolPG[t]) poolPG[t].push(n); }
            }
        });

        generateSchedule(prof);
        
        let db = JSON.parse(localStorage.getItem('dbHistory')||"[]");
        db.unshift({id:Date.now(), seed:currentSeed, prof:prof, date:document.getElementById('startDateInput').value});
        if(db.length>30) db.pop();
        localStorage.setItem('dbHistory',JSON.stringify(db));

        document.getElementById('loadingOverlay').style.display='none';
        btn.disabled = false;
        showToast("DATA SYNC COMPLETED");

        checkPastDays();
        setTimeout(scrollToToday, 500);

    } catch(e) {
        document.getElementById('loadingOverlay').style.display='none';
        btn.disabled = false;
        alert("GAGAL MENGAMBIL DATA. PASTIKAN FORMAT CSV BENAR.");
    }
}

function generateSchedule(prof) {
    let date = new Date(document.getElementById('startDateInput').value);
    let times = {
        "MIDNIGHT": document.getElementById('timeMidnight').value,
        "SIANG": document.getElementById('timeSiang').value,
        "SORE": document.getElementById('timeSore').value,
        "MALAM": document.getElementById('timeMalam').value
    };
    
    let days = ["MINGGU","SENIN","SELASA","RABU","KAMIS","JUMAT","SABTU"];
    
    let html = "";
    globalData = []; codePool = []; globalGenID = 0; 
    let yesterdayThemes = {"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]};
    
    let today = new Date();
    today.setHours(0,0,0,0);

    for(let i=0; i<7; i++) {
        let d = new Date(date); d.setDate(date.getDate()+i);
        let checkDate = new Date(d); checkDate.setHours(0,0,0,0);
        
        let dStr = d.toLocaleDateString('id-ID', {day:'2-digit', month:'2-digit'});
        let dayIndex = d.getDay(); 
        let dName = days[dayIndex];
        
        let dayObj = {day:dName, date:dStr, sessions:[]};
        let dailyGames = [];
        let todayThemes = {"MIDNIGHT":[],"SIANG":[],"SORE":[],"MALAM":[]};
        let prevSessionThemes = [];

        let isPast = checkDate < today;
        let isToday = checkDate.getTime() === today.getTime();
        
        let dayClass = '';
        if(isPast) dayClass = 'day-past';
        if(isToday) dayClass = 'today-highlight';
        let idAttr = isToday ? 'id="todayRow"' : '';

        html += `<div class="day-section ${dayClass}" ${idAttr}>
            <div class="day-title">
                ${dName} <span class="date-badge">${dStr}</span>
                <span class="today-badge">AKTIF SEKARANG</span>
            </div>
            <div class="session-grid">`;

        ["MIDNIGHT","SIANG","SORE","MALAM"].forEach(sess => {
            let counts = resolveGameCounts(prof, sess);
            let sHtml = "", rawTxt = "";
            let currentSessThemes = [];
            
            const draw = (pool, tier) => {
                let res = pickGame(pool, tier, dailyGames, prevSessionThemes, currentSessThemes, yesterdayThemes[sess]);
                if(res.name !== "NO DATA") {
                    dailyGames.push(res.name); 
                    currentSessThemes.push(res.theme);
                    todayThemes[sess].push(res.theme);
                }
                let uid = globalGenID++; 
                let imgUrl = gameImgs[res.name] || 'https://via.placeholder.com/300x300?text=NO+IMG';
                
                return {
                    name: res.name,
                    html: `<div class="game-item-compact" id="gid-${uid}">
                            <div class="g-thumb-wrap">
                                <span class="g-tag-compact tag-${tier}">${tier}</span>
                                <button class="del-compact" onclick="deleteItem('${uid}', event)">âœ•</button>
                                <img src="${imgUrl}" class="g-thumb" loading="lazy" referrerpolicy="no-referrer" alt="${res.name}" onerror="this.src='https://via.placeholder.com/300?text=ERR';this.parentElement.style.border='2px solid red';">
                            </div>
                            <div class="g-info-compact">
                                <span class="g-name-compact">${res.name}</span>
                            </div>
                           </div>`
                };
            };

            const buildProvSection = (label, count, pool, guide) => {
                if(count <= 0) return "";
                let sectHtml = `<div class="prov-section"><span class="prov-label">${label}</span><div class="games-row">`;
                let sectTxt = `--- ${label} ---\n`;
                
                for(let k=0; k<count; k++) {
                    let t = (sess==="SORE") ? 'gold' : (k===0?'gold':(k===1?'silver':'bronze'));
                    let r = draw(pool, t);
                    sectHtml += r.html; sectTxt += r.name + '\n';
                }
                sectHtml += `</div>`; 
                let pt = getPattern(pool.guide, label === 'PRAGMATIC PLAY' ? 'Pragmatic' : 'PGSoft');
                sectHtml += pt.html + `</div>`; 
                sectTxt += `POLA:\n${pt.txt}\n`;
                return {html: sectHtml, txt: sectTxt};
            };

            let ppData = buildProvSection("PRAGMATIC PLAY", counts.pp, poolPP, poolPP.guide);
            sHtml += ppData.html; rawTxt += ppData.txt;

            let pgData = buildProvSection("PG SOFT", counts.pg, poolPG, poolPG.guide);
            sHtml += pgData.html; rawTxt += pgData.txt;

            prevSessionThemes = [...currentSessThemes];
            let dep = getDeposit(sess, prof);
            dayObj.sessions.push({title:sess, time:times[sess], content:rawTxt, depo:dep});

            html += `
            <div class="card">
                <div class="card-header">
                    <div><div class="sess-name">${sess}</div><span class="sess-time">${times[sess]}</span></div>
                    <button class="copy-mini" onclick="copyOne(${i}, ${dayObj.sessions.length-1})"><i class="fas fa-copy"></i></button>
                </div>
                <div class="card-body" id="sess-${i}-${sess}">
                    ${sHtml}
                    <div class="depo-box">
                        <div class="depo-code">KODE UNIK: ${dep.code}</div>
                        ${dep.html}
                    </div>
                </div>
            </div>`;
        });

        html += `</div></div>`;
        globalData.push(dayObj);
        yesterdayThemes = todayThemes; 
    }
    
    document.getElementById('outputArea').innerHTML = html;
    applyDeletions(); 
}

// --- UTILITIES ---
function checkPastDays() {
    let pastItems = document.querySelectorAll('.day-past');
    let btn = document.getElementById('showHistoryBtn');
    if(pastItems.length > 0) {
        btn.style.display = 'block';
        btn.innerHTML = `<i class="fas fa-history"></i> ${pastItems.length} HARI YANG LALU DISEMBUNYIKAN (KLIK UNTUK LIHAT)`;
    } else btn.style.display = 'none';
}
function toggleHistory() {
    let pastItems = document.querySelectorAll('.day-past');
    pastItems.forEach(el => { el.style.display = (el.style.display === 'block') ? '' : 'block'; });
}
function scrollToToday() {
    const el = document.getElementById('todayRow');
    if(el) { el.scrollIntoView({behavior: "smooth", block: "center"}); showToast("JADWAL HARI INI DITEMUKAN"); }
}

function getTheme(gameName) {
    let n = gameName.toLowerCase();
    n = n.replace(/\b(1000|megaways|xmas|christmas|jackpot|deluxe|gold|super scatter|maxways|party)\b/g, "");
    n = n.replace(/[0-9]+/g, ""); n = n.trim();
    if (n.includes("olympus") || n.includes("zeus") || n.includes("gatot")) return "zeus_gatot_family"; 
    if (n.includes("starlight") || n.includes("inces")) return "starlight_family";
    if (n.includes("bonanza") || n.includes("sweet")) return "bonanza_family";
    if (n.includes("mahjong") || n.includes("ways")) return "mahjong_family";
    return n.split(" ")[0]; 
}

function pickGame(pool, tier, dailyGames, prevSessionThemes, currentSessThemes, yesterdayThemes) {
    let fullList = pool[tier];
    if (!fullList || fullList.length === 0) return { name: "NO DATA", theme: "" };
    const isValid = (g, strictLevel) => {
        let theme = getTheme(g);
        if (strictLevel >= 4) { if (yesterdayThemes && yesterdayThemes.includes(theme)) return false; }
        if (strictLevel >= 3) { if (prevSessionThemes.includes(theme)) return false; }
        if (strictLevel >= 2) { if (dailyGames.includes(g)) return false; }
        if (currentSessThemes.includes(theme)) return false;
        return true;
    };
    let candidates = [];
    for (let level = 4; level >= 1; level--) {
        candidates = fullList.filter(g => isValid(g, level));
        if (candidates.length > 0) break; 
    }
    if (candidates.length === 0) {
        candidates = fullList.filter(g => !currentSessThemes.includes(getTheme(g)));
        if (candidates.length === 0) candidates = fullList; 
    }
    return { name: candidates[Math.floor(rnd() * candidates.length)], theme: getTheme(candidates[Math.floor(rnd() * candidates.length)]) };
}

function resolveGameCounts(profile, sessionName) {
    const r = rnd(); 
    if (profile === "CAPTAIN77") {
        if(sessionName === "MIDNIGHT") return { pp:3, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return { pp:2, pg:0 };
        if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 };
    } else if (profile === "JAGUAR77") {
        if(sessionName === "MIDNIGHT") return { pp:3, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:1 };
        if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 };
    } else if (profile === "FUN77") {
        if(sessionName === "MIDNIGHT") return { pp:3, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:0 };
        if(sessionName === "MALAM") return { pp:1, pg:1 };
    } else if (profile === "MUSTANG77") {
        if(sessionName === "MIDNIGHT") return { pp:2, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return { pp:1, pg:0 };
        if(sessionName === "MALAM") return { pp:0, pg:1 };
    } else if (profile === "INDOPEDIA77") {
        if(sessionName === "MIDNIGHT") return { pp:2, pg:2 };
        if(sessionName === "SIANG") return { pp:3, pg:3 };
        if(sessionName === "SORE") return r > 0.5 ? { pp:1, pg:0 } : { pp:2, pg:0 };
        if(sessionName === "MALAM") return r > 0.5 ? { pp:1, pg:0 } : { pp:0, pg:1 };
    } else if (profile === "HOLYPLAY17") {
        if(sessionName === "MIDNIGHT") return { pp:2, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return { pp:2, pg:0 }; 
        if(sessionName === "MALAM") return { pp:0, pg:2 };
    } else if (profile === "INDOFUN17") {
        if(sessionName === "MIDNIGHT") return { pp:2, pg:2 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") return { pp:2, pg:0 };
        if(sessionName === "MALAM") return { pp:0, pg:1 };
    } else if (profile === "PLAY77") {
        if(sessionName === "MIDNIGHT") return r > 0.5 ? { pp:2, pg:0 } : { pp:1, pg:0 };
        if(sessionName === "SIANG") return { pp:2, pg:2 };
        if(sessionName === "SORE") { if (r < 0.33) return { pp:1, pg:0 }; else if (r < 0.66) return { pp:2, pg:0 }; else return { pp:1, pg:1 }; }
        if(sessionName === "MALAM") return { pp:0, pg:1 };
    }
    return { pp:2, pg:2 };
}

function getPattern(list, prov) {
    if(!list || list.length===0) return {html:"", txt:""};
    let sel = [], txt = "";
    let safe = list.filter(x => !x.toUpperCase().includes('BUY'));
    if(safe.length===0) safe=list;
    let type = s => s.toUpperCase().includes('MANUAL')?'M':(s.toUpperCase().includes('AUTO')?'A':'T');
    for(let i=0; i<5; i++) {
        let last = sel.length>0 ? type(sel[sel.length-1]) : null;
        let pool = safe.filter(x => type(x)!==last && !sel.includes(x));
        if(pool.length===0) pool=safe;
        sel.push(pool[Math.floor(rnd()*pool.length)]);
    }
    if(prov==='Pragmatic') {
        let buys = list.filter(x=>x.toUpperCase().includes('BUY'));
        sel.push(buys.length>0?buys[Math.floor(rnd()*buys.length)]:"BUY SPIN SECUKUPNYA");
    }

    let dcHtml = "";
    if(prov === 'Pragmatic') {
        let state = rnd() > 0.5 ? "ON" : "OFF";
        dcHtml = `<span style="background:var(--accent-gold); color:#000; padding:1px 4px; border-radius:3px; font-size:8px; font-weight:800; display:inline-block; margin-bottom:3px;">DC ${state}</span>`;
    }

    let h = `<div class="pattern-box"><div style="font-size:8px;color:var(--accent-gold);font-weight:800;margin-bottom:3px;">BET BEBAS</div>${dcHtml}`;
    sel.forEach(s => {
        let uid = globalGenID++;
        h += `<div class="pt-row" id="gid-${uid}"><span class="pt-txt">${s}</span><button class="del-pt" onclick="deleteItem('${uid}', event)">âœ•</button></div>`;
        txt += `> ${s}\n`;
    });
    h += `<div style="text-align:center;font-size:8px;color:#888;margin-top:3px;">ULANGI POLA</div></div>`;
    txt += `NAIKAN BET BERTAHAP & ULANGI POLANYA`;
    return {html:h, txt:txt};
}

function getDeposit(sess, prof) {
    if(codePool.length===0) { codePool=[1000,2000,3000,4000,5000,6000,7000,8000,9000]; shuffle(codePool); }
    let code = codePool.pop() || 1000;
    let raw = depoData[sess] || [];
    if(prof==="FUN77") raw = raw.slice(0,1);
    if(raw.length===0) return {code:code, html:"", text:""};
    let h="", t="";
    raw.forEach((d,i) => {
        let r = d.range.split('-');
        let v1 = parseInt(r[0].replace(/\D/g,'')) + code;
        let v2 = r[1] ? parseInt(r[1].replace(/\D/g,'')) + code : null;
        let s = `Rp ${v1.toLocaleString()}` + (v2?` - Rp ${v2.toLocaleString()}`:'');
        let info = d.info.split('|');
        h += `<div class="depo-row"><span>${i+1}. ${s}</span><span style="color:var(--accent-gold)">${info[0]||''}</span></div>`;
        t += `${i+1}. ${s} (${info[0]||''})\n`;
    });
    return {code:code, html:h, text:t};
}

// --- SYNC & STATE ---
function deleteItem(uid, e) {
    if(e) e.stopPropagation();
    const el = document.getElementById('gid-' + uid);
    if(el) { el.style.opacity = '0'; setTimeout(() => el.remove(), 200); deletedIDs.add(uid.toString()); updateUrlState(); }
}
function applyDeletions() { deletedIDs.forEach(uid => { const el = document.getElementById('gid-' + uid); if(el) el.remove(); }); }
function updateUrlState() {
    let u = new URL(location.href);
    u.searchParams.set('seed', currentSeed);
    u.searchParams.set('profile', document.getElementById('profileSelect').value);
    u.searchParams.set('date', document.getElementById('startDateInput').value);
    if(deletedIDs.size > 0) u.searchParams.set('del', Array.from(deletedIDs).join(','));
    else u.searchParams.delete('del');
    history.replaceState(null, '', u);
}

// --- UI UTILS ---
function updateUI() {
    let p = document.getElementById('profileSelect').value;
    document.documentElement.style.setProperty('--accent-gold', THEMES[p]?.main || '#D4AF37');
}
function updateDateDisplay() { /* handled by url state */ }
function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('active'); }
function toggleMode() { document.body.classList.toggle('clean-mode'); }
function hardReset() { if(confirm("Refresh System & Clear Cache?")) { localStorage.clear(); location.href = location.pathname; } }
function showToast(m) { let t=document.getElementById('customToast'); t.innerText=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',3000); }

// --- EXPORT & COPY ---
function exportForDesigner() {
    if(globalData.length === 0) return showToast("GENERATE DULU!");
    const profile = document.getElementById('profileSelect').value;
    const dateInput = document.getElementById('startDateInput').value;
    const themeColor = THEMES[profile]?.main || '#D4AF37'; 
    let brief = `ðŸ“‹ **BRIEF DESAIN - ${profile}**\nðŸ“… TGL: ${dateInput}\nðŸŽ¨ WARNA: ${themeColor}\n------------------\n`;
    globalData.forEach(d => {
        brief += `\n>> ${d.day.toUpperCase()}, ${d.date}\n`;
        d.sessions.forEach(s => {
            brief += `[${s.title}]\n`;
            let games = s.content.split('\n').filter(l => !l.includes('---') && !l.includes('POLA:') && !l.includes('>') && l.trim() !== '');
            games.forEach(g => brief += `- ${g.trim()}\n`);
            brief += `Kode: ${s.depo.code}\n`; 
        });
    });
    document.getElementById('resultText').value = brief;
    document.getElementById('resultModal').style.display = 'flex';
}

function extractDOM(dom) {
    let txt = "";
    dom.querySelectorAll('.prov-label, .g-name-compact, .pattern-box').forEach(el => {
        if(el.classList.contains('prov-label')) txt += `\n--- ${el.innerText} ---\n`;
        if(el.classList.contains('g-name-compact')) txt += `${el.innerText}\n`;
        if(el.classList.contains('pattern-box')) {
            txt += "POLA:\n";
            el.querySelectorAll('.pt-txt').forEach(p => txt += `> ${p.innerText}\n`);
            txt += "NAIKAN BET BERTAHAP\n";
        }
    });
    return txt;
}
function copyOne(d, s) {
    let data = globalData[d].sessions[s];
    let dom = document.getElementById(`sess-${d}-${data.title}`);
    let content = extractDOM(dom);
    let final = `HARI: ${globalData[d].day}, ${globalData[d].date}\nSESI: ${data.title} (${data.time})\n\n${content}\nKODE UNIK: ${data.depo.code}\n${data.depo.text}`;
    document.getElementById('resultText').value = final;
    document.getElementById('resultModal').style.display='flex';
}
function copyWeek() {
    if(globalData.length===0) return showToast("DATA KOSONG");
    let t = `JADWAL MINGGUAN ${document.getElementById('startDateInput').value}\n\n`;
    globalData.forEach((d,i) => {
        t += `â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“… ${d.day}\nâ”â”â”â”â”â”â”â”â”â”â”â”\n`;
        d.sessions.forEach((s, idx) => {
            let dom = document.getElementById(`sess-${i}-${s.title}`);
            t += `[ ${s.title} ]\n${extractDOM(dom)}\nKode: ${s.depo.code}\n\n`;
        });
    });
    document.getElementById('resultText').value = t;
    document.getElementById('resultModal').style.display='flex';
}
function finalCopy() { document.getElementById('resultText').select(); document.execCommand('copy'); showToast("BERHASIL DISALIN!"); }
function shareLink() { updateUrlState(); navigator.clipboard.writeText(location.href).then(() => showToast("LINK TERSIMPAN!")); }

// --- INIT ---
function initLoad() {
    let p = new URLSearchParams(location.search);
    if(p.get('del')) p.get('del').split(',').forEach(id => deletedIDs.add(id));
    if(p.get('seed')) {
        currentSeed = parseInt(p.get('seed'));
        rnd = mulberry32(currentSeed);
        document.getElementById('profileSelect').value = p.get('profile');
        document.getElementById('startDateInput').value = p.get('date');
        updateUI();
        fetchData();
    } else {
        document.getElementById('startDateInput').valueAsDate = new Date();
        initVisuals();
    }
}

window.onload = () => {
    if(localStorage.getItem('isLoggedIn') === 'true') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        initLoad();
    }
};

const ctx = document.getElementById('nebula-canvas').getContext('2d');
function initVisuals() {
    let w=window.innerWidth, h=window.innerHeight;
    document.getElementById('nebula-canvas').width=w; document.getElementById('nebula-canvas').height=h;
    let hue=0;
    function anim() {
        if(document.body.classList.contains('clean-mode')) return requestAnimationFrame(anim);
        ctx.fillStyle=`rgba(0,0,0,0.05)`; ctx.fillRect(0,0,w,h);
        ctx.fillStyle=`hsla(${hue}, 50%, 50%, 0.5)`;
        ctx.beginPath(); ctx.arc(Math.random()*w, Math.random()*h, Math.random()*2, 0, Math.PI*2); ctx.fill();
        hue+=0.5; requestAnimationFrame(anim);
    }
    anim();
}
</script>
</body>
</html>
